<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ipTIME ìŠ¤ì¼€ì¤„ëŸ¬</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{background:#f5f6f8}
  :root{
    --bg:#f5f6f8;--card:#fff;--primary:#4a7c59;--pl:#e8f0eb;--pd:#3a6247;
    --accent:#e8913a;--al:#fff4e8;--danger:#d9534f;--dl:#fdecea;
    --sched:#818cf8;--sched-light:#eef2ff;
    --text:#1a1a2e;--ts:#6b7280;--border:#e5e7eb;
    --sh:0 1px 3px rgba(0,0,0,.06);--sh-md:0 4px 12px rgba(0,0,0,.08);--sh-lg:0 12px 40px rgba(0,0,0,.15);
    --r:14px;--rs:8px;
    --green-bold:#1b6e2d;--green-bold-hover:#155a24;
  }
  body{font-family:'Noto Sans KR',-apple-system,sans-serif;background:var SVG_EDIT_SMALL='<svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M16.4124 5.75744C16.8218 5.37069 17.4904 5.37069 17.8997 5.75744L19.133 6.92272C19.5402 7.30268 19.5455 7.9431 19.1366 8.32457L17.6997 9.68213L14.9765 7.10931L16.4124 5.75744ZM13.8764 8.14506L13.826 8.19247L4.5531 16.962V19.5326H7.2737L16.6014 10.7197L13.8764 8.14506ZM18.9979 4.71984C17.9822 3.76018 16.3305 3.76005 15.3146 4.71947L12.7285 7.15421L3 16.3546V21H7.91701L20.2296 9.36705C21.2568 8.40694 21.2568 6.84361 20.2295 5.8835L18.9979 4.71984Z" fill="currentColor"/></svg>';

document.querySelectorAll('.routine-card').forEach(function(c){
  var ei=document.createElement('div');ei.className='edit-icon';ei.innerHTML=SVG_EDIT_SMALL;
  c.insertBefore(ei,c.firstChild);
});

var(--bg);color:var(--text);min-height:100vh;padding:24px}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
  .header h1{font-size:22px;font-weight:700}
  .header-actions{display:flex;gap:8px}
  .hdr-btn{width:36px;height:36px;padding:0;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:var(--rs);background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:18px;transition:all .15s}
  .hdr-btn:hover{background:#f3f4f6}
  .hdr-btn.green{background:#1b6e2d;color:#fff;border-color:#1b6e2d}
  .hdr-btn.green:hover{background:#155a24}
  .hdr-btn.disabled{pointer-events:none}
  .stats{display:flex;gap:12px;margin-bottom:24px;position:sticky;top:0;z-index:50;padding:12px 0;background:#f5f6f8}
  .stat-chip{background:var(--card);border-radius:var(--rs);padding:10px 16px;font-size:13px;color:var(--ts);box-shadow:var(--sh);display:flex;align-items:center;gap:8px;cursor:pointer;transition:all .15s;user-select:none}
  .stat-chip:hover{box-shadow:var(--sh-md)}
  .stat-chip.active{background:var(--pl);color:var(--primary);box-shadow:var(--sh-md)}
  .stat-chip .num{font-weight:700;font-size:18px;color:var(--text)}
  .tl-card{background:var(--card);border-radius:var(--r);box-shadow:var(--sh);padding:20px 24px;margin-bottom:28px}
  .tl-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .tl-title{font-size:16px;font-weight:700}
  .tl-nav{display:flex;align-items:center;gap:4px}
  .tl-nav-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:var(--rs);background:var(--card);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--ts);transition:all .15s}
  .tl-nav-btn:hover{background:#f3f4f6;color:var(--text)}
  .tl-date-display{padding:6px 18px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-weight:600;background:var(--card);min-width:110px;text-align:center}
  .tl-today-btn{padding:6px 14px;border:1px solid var(--border);border-radius:var(--rs);background:var(--card);font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s}
  .tl-today-btn:hover{background:#f3f4f6}
  .tl-collapse-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:var(--rs);background:var(--card);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;color:var(--ts);transition:all .15s}
  .tl-collapse-btn:hover{background:#f3f4f6}
  .tl-ruler{position:relative;height:20px}
  .tl-ruler .tick{position:absolute;bottom:0;font-size:10px;color:#b0b5bf;transform:translateX(-50%);font-weight:500}
  .tl-ruler .tick::before{content:'';position:absolute;bottom:16px;left:50%;width:1px;height:6px;background:#e0e3e8}
  .tl-body{position:relative;margin-top:2px;min-height:60px}
  .tl-grid-lines{position:absolute;inset:0;pointer-events:none;z-index:0}
  .tl-grid-line{position:absolute;top:0;bottom:0;width:1px;background:#f0f1f3}
  .tl-tracks{position:relative;z-index:1;display:flex;flex-direction:column;gap:4px;padding:6px 0}
  .tl-bar{position:absolute;height:28px;border-radius:6px;display:flex;align-items:center;padding:0 8px;font-size:11px;font-weight:600;color:#fff;white-space:nowrap;overflow:visible;text-overflow:ellipsis;cursor:pointer;transition:filter .15s;z-index:1}
  .tl-bar:hover{filter:brightness(1.1);z-index:5}
  .tl-bar:active{filter:brightness(.95)}
  .tl-bar.running{background:var(--primary)}
  .tl-bar.scheduled{background:var(--sched)}
  .tl-bar.oneshot{background:var(--accent);border:2px dashed rgba(255,255,255,.4)}
  .tl-bar .badge{position:absolute;top:-6px;right:-6px;min-width:18px;height:18px;border-radius:9px;background:var(--danger);color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 4px;box-shadow:0 1px 3px rgba(0,0,0,.2)}
  .tl-overlap{position:absolute;border:2px dashed var(--danger);border-radius:8px;background:rgba(217,83,79,.04);pointer-events:none;z-index:0}
  .tl-now{position:absolute;top:0;bottom:0;width:2px;background:var(--danger);z-index:10;pointer-events:none}
  .tl-now::before{content:'';position:absolute;top:-4px;left:-4px;width:10px;height:10px;background:var(--danger);border-radius:50%}
  .tl-legend{display:flex;gap:16px;margin-top:14px;font-size:11px;color:var(--ts);font-weight:500}
  .tl-legend-item{display:flex;align-items:center;gap:5px}
  .tl-legend-dot{width:10px;height:10px;border-radius:3px}
  .tl-legend-dot.lg-run{background:var(--primary)}
  .tl-legend-dot.lg-sched{background:var(--sched)}
  .tl-legend-dot.lg-one{background:var(--accent);border:1.5px dashed rgba(0,0,0,.15)}
  .tl-legend-dot.lg-overlap{background:transparent;border:2px dashed var(--danger);width:12px;height:12px;border-radius:4px}
  .tl-tooltip{position:fixed;background:#1a1a2e;color:#fff;border-radius:10px;padding:14px 16px;font-size:12px;max-width:280px;box-shadow:0 8px 30px rgba(0,0,0,.25);z-index:1000;pointer-events:none;opacity:0;transition:opacity .15s}
  .tl-tooltip.show{opacity:1}
  .tl-tooltip h4{font-size:13px;font-weight:700;margin-bottom:4px}
  .tl-tooltip .tt-time{color:#9ca3af;margin-bottom:8px;font-size:11px}
  .tl-tooltip .tt-list{list-style:none;padding:0}
  .tl-tooltip .tt-list li{padding:2px 0;font-size:11px}
  .tl-tooltip .tt-list li::before{content:'Â·';margin-right:6px;color:var(--primary)}
  .tl-tooltip .tt-overlap{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.15);color:var(--accent);font-size:11px}
  .routine-list{display:flex;flex-direction:column;gap:14px;padding-bottom:24px}
  .routine-card-wrap{display:flex;align-items:stretch;gap:0;position:relative;margin-left:-28px;padding-left:28px}
  .outer-drag-handle{width:28px;display:flex;align-items:center;justify-content:center;color:transparent;font-size:16px;cursor:grab;user-select:none;transition:color .25s;flex-shrink:0;position:absolute;left:0;top:0;bottom:0;border-radius:6px 0 0 6px}
  .routine-card-wrap:hover .outer-drag-handle{color:#d4d8de}
  .outer-drag-handle:hover{color:#b0b5bf !important}
  .outer-drag-handle:active{cursor:grabbing;color:#9ca3af !important}
  .routine-card{background:var(--card);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;border:1px solid transparent;transition:box-shadow .2s,border-color .2s;position:relative;flex:1;min-width:0}
  .routine-card:hover{box-shadow:var(--sh-md);border-color:var(--border)}
  .routine-card-wrap.dragging .routine-card{opacity:.5;box-shadow:var(--sh-lg)}
  .routine-card-wrap.dragging{z-index:100}
  .routine-card-wrap.drag-over-top .routine-card{border-top:3px solid var(--primary)}
  .routine-card-wrap.drag-over-bottom .routine-card{border-bottom:3px solid var(--primary)}
  .routine-card.disabled-svc{opacity:.75}
  .routine-card.disabled-svc .card-top::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none}
  .svc-warn{display:flex;align-items:center;gap:6px;padding:6px 10px;margin:8px 20px 10px;border-radius:6px;background:#f9fafb;border:1px solid var(--border);font-size:11px;color:var(--ts);font-weight:500}
  .svc-warn-dot{width:6px;height:6px;border-radius:50%;background:#c9cdd4;flex-shrink:0}
  .drag-handle{display:none}
  .swipe-wrapper{position:relative;overflow:hidden;border-radius:var(--r)}
  .swipe-bg{position:absolute;top:0;right:0;bottom:0;width:80px;background:var(--danger);display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:600;border-radius:0 var(--r) var(--r) 0;opacity:0;transition:opacity .15s}
  .swipe-bg.show{opacity:1}
  .swipe-inner{position:relative;background:var(--card);transition:transform .2s ease;z-index:1;border-radius:var(--r)}
  .routine-card.bulk-mode .card-top{padding-left:40px}
  .routine-card.bulk-mode .card-body{padding-left:40px}
  .routine-card.bulk-mode .card-footer{padding-left:40px}
  .routine-card .bulk-check{position:absolute;top:20px;left:14px;width:20px;height:20px;border:2px solid var(--border);border-radius:6px;background:var(--card);cursor:pointer;display:none;align-items:center;justify-content:center;font-size:11px;transition:all .15s;z-index:2}
  .routine-card.bulk-mode .bulk-check{display:flex}
  .routine-card .edit-icon{position:absolute;top:20px;left:14px;width:20px;height:20px;border-radius:6px;background:var(--pl);color:var(--primary);display:none;align-items:center;justify-content:center;z-index:2}
  .routine-card.edit-mode .edit-icon{display:flex}
  .routine-card.edit-mode .card-top{padding-left:40px}
  .routine-card.edit-mode .card-body{padding-left:40px}
  .routine-card.edit-mode .card-footer{padding-left:40px}
  .routine-card .bulk-check.checked{background:var(--primary);border-color:var(--primary);color:#fff}
  .routine-card.bulk-selected{border-color:var(--border)}
  .routine-card.edit-mode{cursor:pointer}
  .routine-card.edit-mode:hover{box-shadow:var(--sh-md);background:#f0fdf4}
  .card-top{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 0}
  .card-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .priority-num{font-size:13px;font-weight:700;color:#b0b5bf;flex-shrink:0;font-variant-numeric:tabular-nums}
  .routine-card-wrap:first-of-type .priority-num{color:var(--primary)}
  .routine-card-wrap:nth-of-type(2) .priority-num{color:var(--primary);opacity:.7}
  .status-badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;display:inline-flex;align-items:center;gap:5px}
  .status-badge::before{content:'';width:6px;height:6px;border-radius:50%;flex-shrink:0}
  .status-badge.running{background:var(--pl);color:var(--primary)}
  .status-badge.running::before{background:var(--primary)}
  .status-badge.scheduled{background:var(--sched-light);color:var(--sched)}
  .status-badge.scheduled::before{background:var(--sched)}
  .status-badge.oneshot{background:var(--al);color:var(--accent)}
  .status-badge.oneshot::before{background:var(--accent)}
  .type-badge{font-size:11px;font-weight:500;padding:3px 8px;border-radius:4px;background:#f3f4f6;color:var(--ts)}
  .card-toggle{position:relative;width:42px;height:24px;background:#d1d5db;border-radius:12px;cursor:pointer;border:none;flex-shrink:0;transition:background .2s}
  .card-toggle.on{background:var(--primary)}
  .card-toggle::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.15)}
  .card-toggle.on::after{transform:translateX(18px)}
  .card-body{padding:14px 20px 0;cursor:pointer}
  .schedule-row{display:flex;align-items:center;gap:16px;margin-bottom:12px;flex-wrap:wrap}
  .schedule-info{display:flex;align-items:center;gap:6px}
  .day-pills{display:flex;gap:3px}
  .day-pill{width:24px;height:24px;border-radius:50%;font-size:10px;font-weight:600;display:flex;align-items:center;justify-content:center;background:#f3f4f6;color:#c9cdd4}
  .day-pill.active{background:var(--primary);color:#fff}
  .card-day-bar{display:flex;margin-right:8px}
  .card-day-bar span{height:26px;padding:0 7px;border:1px solid var(--border);background:var(--card);font-size:11px;font-weight:600;color:#c9cdd4;display:flex;align-items:center;justify-content:center;margin-left:-1px}
  .card-day-bar span:first-child{border-radius:5px 0 0 5px;margin-left:0}
  .card-day-bar span:last-child{border-radius:0 5px 5px 0}
  .card-day-bar span.active{border-color:var(--primary);background:var(--primary);color:#fff;z-index:1;position:relative}
  .time-range{display:inline-flex;align-items:center;gap:4px;background:#f9fafb;padding:3px 10px;border-radius:5px;font-size:12.5px;font-weight:500}
  .action-summary{display:flex;align-items:center;gap:8px;padding:4px 0 14px;font-size:12px;color:var(--ts);user-select:none;transition:opacity .15s}
  .action-summary:hover{color:var(--text)}
  .action-summary .summary-text{flex:1}
  .action-summary .summary-text strong{color:var(--text);font-weight:600}
  .action-summary .chevron{font-size:10px;color:#b0b5bf;transition:transform .2s}
  .action-summary .chevron.open{transform:rotate(180deg)}
  .action-summary .count-badge{font-size:10px;font-weight:700;background:#f3f4f6;color:var(--text);padding:2px 7px;border-radius:4px}
  .action-detail{overflow:hidden;max-height:0;opacity:0;transition:max-height .3s ease,opacity .2s}
  .action-detail.open{max-height:500px;opacity:1;padding-bottom:16px}
  .compact-list{display:flex;flex-direction:column}
  .compact-item{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px;font-weight:500;color:var(--text)}
  .compact-item+.compact-item{border-top:1px solid #f3f4f6}
  .compact-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
  .compact-action{color:var(--ts);font-weight:400;margin-left:auto;font-size:11px;flex-shrink:0}
  .compact-target{font-size:10px;color:var(--primary);background:var(--pl);padding:1px 6px;border-radius:3px;margin-left:4px;flex-shrink:0}
  .card-footer{display:flex;align-items:center;justify-content:space-between;padding:8px 20px;background:#fafbfc;border-top:1px solid var(--border);font-size:11.5px;color:var(--ts)}
  .card-footer-actions{position:relative}
  .card-footer-actions .edit-btn{border:none;background:transparent;color:var(--ts);cursor:pointer;padding:4px 8px;border-radius:4px;font-size:12px;font-family:inherit;transition:all .15s}
  .card-footer-actions .edit-btn:hover{background:#f3f4f6;color:var(--text)}
  .empty-state{display:none;text-align:center;padding:48px 24px;background:var(--card);border-radius:var(--r);box-shadow:var(--sh);border:2px dashed var(--border)}
  .empty-state.show{display:block}
  .empty-state-icon{font-size:40px;margin-bottom:12px;opacity:.4}
  .empty-state-title{font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px}
  .empty-state-desc{font-size:13px;color:var(--ts);line-height:1.5}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);z-index:100;display:none;align-items:center;justify-content:center;overflow-y:auto;padding:24px 0}
  .overlay.show{display:flex}
  .modal{background:var(--card);border-radius:18px;box-shadow:var(--sh-lg);width:720px;max-width:95vw;overflow-y:visible;animation:up .25s ease}
  @keyframes up{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:22px 28px 0;background:var(--card);z-index:2;border-radius:18px 18px 0 0}
  .modal-header h2{font-size:18px;font-weight:700}
  .modal-close{width:32px;height:32px;border:none;background:transparent;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .modal-close:hover{background:#f3f4f6}
  .modal-body{padding:20px 28px 40px}
  .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
  @media(max-width:640px){.modal-grid{grid-template-columns:1fr}.section-title{margin-top:16px}}
  .section-title{font-size:13px;font-weight:700;color:var(--primary);margin-bottom:14px;text-transform:uppercase;letter-spacing:.5px}
  .tab-group{display:flex;gap:4px;background:#f3f4f6;border-radius:10px;padding:3px;margin-bottom:16px}
  .tab-btn{flex:1;padding:8px 0;text-align:center;border:none;background:transparent;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s}
  .tab-btn.active{background:var(--card);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1);font-weight:600}
  .repeat-tabs{display:flex;gap:4px;background:#f3f4f6;border-radius:8px;padding:3px;margin-bottom:14px}
  .repeat-tab{flex:1;padding:6px 0;text-align:center;border:none;background:transparent;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s}
  .repeat-tab.active{background:var(--card);color:var(--text);box-shadow:0 1px 2px rgba(0,0,0,.08);font-weight:600}
  .day-selector{display:flex;margin-bottom:10px}
  .day-btn{flex:1;height:36px;border:1px solid var(--border);background:var(--card);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s;margin-left:-1px}
  .day-btn:first-child{border-radius:6px 0 0 6px;margin-left:0}
  .day-btn:last-child{border-radius:0 6px 6px 0}
  .day-btn.selected{border-color:var(--primary);background:var(--primary);color:#fff;z-index:1;position:relative}
  .day-btn:hover:not(.selected){background:#f3f4f6;color:var(--text)}
  .day-presets{display:flex;gap:6px;margin-bottom:10px}
  .day-preset-btn{padding:4px 12px;border:1.5px solid var(--border);border-radius:20px;background:transparent;font-size:11px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s}
  .day-preset-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--pl)}
  .day-preset-btn.active{border-color:var(--primary);background:var(--primary);color:#fff}
  .date-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:10px}
  .date-cell{height:34px;border-radius:8px;border:1.5px solid var(--border);background:transparent;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s;display:flex;align-items:center;justify-content:center}
  .date-cell.selected{border-color:var(--primary);background:var(--primary);color:#fff}
  .date-cell:hover:not(.selected){border-color:var(--primary);color:var(--primary)}
  .date-cell.last-day{background:#f9fafb;font-size:10px;grid-column:span 2}
  .date-cell.last-day.selected{background:var(--primary)}
  .date-presets{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
  .date-preset-btn{padding:4px 10px;border:1.5px solid var(--border);border-radius:20px;background:transparent;font-size:11px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s}
  .date-preset-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--pl)}
  .date-preset-btn.active{border-color:var(--primary);background:var(--primary);color:#fff}
  .schedule-summary{margin-top:16px;padding:12px 14px;border-radius:10px;background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:1px solid rgba(74,124,89,.15);display:flex;align-items:flex-start;gap:10px;transition:all .3s ease;min-height:44px}
  .schedule-summary.empty{background:#f9fafb;border-color:var(--border)}
  .schedule-summary-icon{display:none}
  .schedule-summary-text{font-size:12.5px;font-weight:500;color:var(--text);line-height:1.5}
  .schedule-summary.empty .schedule-summary-text{color:var(--ts)}
  .summary-highlight{color:var(--primary);font-weight:700}
  .summary-dim{color:var(--ts);font-weight:400;font-size:11.5px}
  .time-inputs{display:flex;align-items:center;gap:10px}
  .time-input-wrap{flex:1}
  .time-input-wrap label{font-size:11px;color:var(--ts);font-weight:500;display:block;margin-bottom:4px}
  .time-input{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:14px;font-family:inherit;outline:none;transition:border .15s;background:var(--card);accent-color:var(--primary);color-scheme:light}
  .time-input:focus{border-color:var(--primary)}
  .time-sep{font-size:18px;color:#d1d5db;margin-top:16px}
  .datetime-input{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:14px;font-family:inherit;outline:none;transition:border .15s;margin-bottom:12px;accent-color:var(--primary);color-scheme:light}
  .datetime-input:focus{border-color:var(--primary)}
  .ctp-wrap{position:relative}
  .ctp-trigger{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:14px;font-family:inherit;background:var(--card);cursor:pointer;transition:border .15s;text-align:center;user-select:none}
  .ctp-trigger:hover{border-color:#d1d5db}
  .ctp-trigger.open{border-color:var(--primary)}
  .ctp-trigger.error{border-color:var(--danger);background:#fff5f5}
  .ctp-panel{position:absolute;top:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--card);border:1.5px solid var(--primary);border-radius:var(--rs);box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:60;display:none;padding:8px;gap:4px;align-items:center}
  .ctp-panel.show{display:flex}
  .ctp-col{max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;width:48px}
  .ctp-col::-webkit-scrollbar{display:none}
  .ctp-col{scrollbar-width:none}
  .ctp-cell{padding:6px 4px;text-align:center;border-radius:5px;font-size:13px;font-weight:500;cursor:pointer;transition:all .1s;color:var(--ts)}
  .ctp-cell:hover{background:#f3f4f6;color:var(--text)}
  .ctp-cell.selected{background:var(--primary);color:#fff;font-weight:600}
  .ctp-sep{font-size:16px;color:#d1d5db;font-weight:700;padding:0 2px}
  .cdtp-wrap{position:relative;margin-bottom:12px}
  .cdtp-trigger{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:14px;font-family:inherit;background:var(--card);cursor:pointer;transition:border .15s;user-select:none}
  .cdtp-trigger:hover{border-color:#d1d5db}
  .cdtp-trigger.open{border-color:var(--primary)}
  .cdtp-trigger.error{border-color:var(--danger);background:#fff5f5}
  .cdtp-trigger .placeholder{color:#9ca3af}
  .cdtp-panel{position:absolute;top:calc(100% + 4px);left:0;background:var(--card);border:1.5px solid var(--primary);border-radius:var(--rs);box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:60;display:none;padding:14px;width:280px}
  .cdtp-panel.show{display:block}
  .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .cal-header span{font-size:13px;font-weight:700}
  .cal-nav{width:28px;height:28px;border:1px solid var(--border);border-radius:6px;background:var(--card);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;color:var(--ts);font-family:inherit}
  .cal-nav:hover{background:#f3f4f6}
  .cal-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px}
  .cal-dow span{text-align:center;font-size:10px;font-weight:600;color:var(--ts);padding:4px 0}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
  .cal-day{height:32px;border-radius:6px;border:none;background:transparent;font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--text);display:flex;align-items:center;justify-content:center;transition:all .1s}
  .cal-day:hover:not(.other){background:#f3f4f6}
  .cal-day.today{border:1.5px solid var(--primary);font-weight:700}
  .cal-day.selected{background:var(--primary);color:#fff;font-weight:700}
  .cal-day.other{color:#d1d5db;cursor:default}
  .cal-time{display:flex;align-items:center;gap:4px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);justify-content:center}
  .cal-time-col{max-height:140px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;width:48px}
  .cal-time-col::-webkit-scrollbar{display:none}
  .cal-time-col{scrollbar-width:none}
  .cal-time-cell{padding:5px 4px;text-align:center;border-radius:5px;font-size:12px;font-weight:500;cursor:pointer;transition:all .1s;color:var(--ts)}
  .cal-time-cell:hover{background:#f3f4f6;color:var(--text)}
  .cal-time-cell.selected{background:var(--primary);color:#fff;font-weight:600}
  .cal-time-sep{font-size:16px;color:#d1d5db;font-weight:700}
  .timing-mode{display:flex;gap:4px;background:#f3f4f6;border-radius:8px;padding:3px}
  .timing-btn{flex:1;padding:6px 0;text-align:center;border:none;background:transparent;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s}
  .timing-btn.active{background:var(--card);color:var(--text);box-shadow:0 1px 2px rgba(0,0,0,.08);font-weight:600}
  .action-item{background:#f9fafb;border:1.5px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px;transition:border-color .15s}
  .action-item:hover{border-color:#d1d5db}
  .action-item-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .action-remove{width:24px;height:24px;border:none;background:transparent;color:#d1d5db;cursor:pointer;border-radius:6px;font-size:16px;transition:all .15s;display:flex;align-items:center;justify-content:center}
  .action-remove:hover{background:var(--dl);color:var(--danger)}
  .form-row{margin-bottom:10px}
  .form-label{font-size:11px;color:var(--ts);font-weight:500;display:block;margin-bottom:4px}
  .form-select{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;outline:none;background:var(--card);cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%239CA3AF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;transition:border .15s}
  .form-select:focus{border-color:var(--primary)}
  .action-btns{display:flex;gap:4px;flex-wrap:wrap}
  .action-type-btn{padding:5px 12px;border:1.5px solid var(--border);border-radius:6px;background:transparent;font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s}
  .action-type-btn.selected{border-color:var(--primary);background:var(--pl);color:var(--primary);font-weight:600}
  .action-type-btn:hover:not(.selected){border-color:#d1d5db}
  .add-action-btn{width:100%;padding:10px;border:2px dashed var(--border);border-radius:10px;background:transparent;font-size:13px;font-weight:500;color:var(--ts);cursor:pointer;font-family:inherit;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px}
  .add-action-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--pl)}
  .oneshot-toggle{display:flex;align-items:center;gap:10px;padding:14px 0 0;border-top:1px solid var(--border);margin-top:14px;cursor:pointer;user-select:none}
  .check-box{width:20px;height:20px;border:2px solid var(--border);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .15s;flex-shrink:0}
  .check-box.checked{background:var(--primary);border-color:var(--primary);color:#fff}
  .oneshot-label{font-size:13px;color:var(--text)}
  .modal-footer{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:16px 28px;border-top:1px solid var(--border);background:var(--card);border-radius:0 0 18px 18px}
  .modal-error{font-size:12px;color:var(--danger);font-weight:500;opacity:0;transition:opacity .2s}
  .modal-error.show{opacity:1}
  .form-select.error,.time-input.error,.datetime-input.error{border-color:var(--danger);background:#fff5f5}
  .shake{animation:shake .3s}
  @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-4px)}40%,80%{transform:translateX(4px)}}
  .btn-cancel{padding:10px 24px;border:1.5px solid var(--border);border-radius:var(--rs);background:var(--card);font-size:14px;font-weight:500;cursor:pointer;font-family:inherit;color:var(--ts);transition:all .15s}
  .btn-cancel:hover{background:#f3f4f6}
  .btn-save{padding:10px 32px;border:none;border-radius:var(--rs);background:var(--primary);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;color:#fff;transition:all .15s}
  .btn-save:hover{background:var(--pd)}
  .svc-status-row{display:flex;align-items:center;gap:8px;margin-top:6px;padding:8px 10px;border-radius:8px;font-size:11.5px;font-weight:500;transition:all .2s}
  .svc-status-row.ready{background:#f0fdf4;border:1px solid rgba(74,124,89,.12);color:var(--primary)}
  .svc-status-row.unavail{background:#f9fafb;border:1px solid var(--border);color:var(--ts)}
  .svc-status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
  .svc-status-row.ready .svc-status-dot{background:var(--primary)}
  .svc-status-row.unavail .svc-status-dot{background:#c9cdd4}
  .svc-status-label{flex:1}
  .svc-status-tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;flex-shrink:0}
  .svc-status-row.ready .svc-status-tag{background:rgba(74,124,89,.1);color:var(--primary)}
  .svc-status-row.unavail .svc-status-tag{background:#f3f4f6;color:#9ca3af}
  .svc-select-wrap{position:relative}
  .svc-select-trigger{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;outline:none;background:var(--card);cursor:pointer;display:flex;align-items:center;gap:8px;transition:border .15s}
  .svc-select-trigger:hover{border-color:#d1d5db}
  .svc-select-trigger.open{border-color:var(--primary);border-radius:var(--rs) var(--rs) 0 0}
  .svc-select-trigger.error{border-color:var(--danger);background:#fff5f5}
  .svc-select-trigger .trigger-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
  .svc-select-trigger .trigger-text{flex:1;text-align:left}
  .svc-select-trigger .trigger-placeholder{color:#9ca3af}
  .svc-select-trigger .trigger-arrow{font-size:18px;color:#9ca3af;transition:transform .15s;transform:rotate(90deg);line-height:1}
  .svc-select-trigger.open .trigger-arrow{transform:rotate(270deg)}
  .svc-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1.5px solid var(--primary);border-top:none;border-radius:0 0 var(--rs) var(--rs);box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:50;max-height:280px;overflow-y:auto;display:none}
  .svc-dropdown.show{display:block}
  .svc-dropdown-group{padding:6px 0}
  .svc-dropdown-group+.svc-dropdown-group{border-top:1px solid var(--border)}
  .svc-dropdown-group-label{padding:4px 14px;font-size:10px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:.5px}
  .svc-dropdown-item{display:flex;align-items:center;gap:8px;padding:8px 14px;cursor:pointer;transition:background .1s;font-size:13px}
  .svc-dropdown-item:hover{background:#f3f4f6}
  .svc-dropdown-item.selected{background:var(--pl)}
  .svc-dropdown-item .item-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
  .svc-dropdown-item .item-dot.st-ready{background:#22c55e}
  .svc-dropdown-item .item-dot.st-unavail{background:#d1d5db}
  .svc-dropdown-item .item-name{flex:1;font-weight:500}
  .svc-dropdown-item.is-unavail .item-name{color:#9ca3af}
  .svc-dropdown-item .item-tag{font-size:9.5px;font-weight:600;padding:1px 6px;border-radius:3px;flex-shrink:0}
  .svc-dropdown-item .item-tag.tag-ready{background:#dcfce7;color:#166534}
  .svc-dropdown-item .item-tag.tag-unavail{background:#f3f4f6;color:#9ca3af}
  @media(max-width:600px){body{padding:12px}.stats{flex-wrap:wrap}}
</style>
</head>
<body>

<div class="tl-card" id="tlCard">
  <div class="tl-top"><span class="tl-title">íƒ€ì„ë¼ì¸</span><div class="tl-nav"><button class="tl-nav-btn" onclick="shiftDay(-1)">â—€</button><span class="tl-date-display" id="tlDateDisp"></span><button class="tl-nav-btn" onclick="shiftDay(1)">â–¶</button><button class="tl-today-btn" onclick="goToday()">ì˜¤ëŠ˜</button><button class="tl-collapse-btn" onclick="toggleTl()">âˆ§</button></div></div>
  <div id="tlContent"><div class="tl-ruler" id="tlRuler"></div><div class="tl-body" id="tlBody"><div class="tl-grid-lines" id="tlGrid"></div><div class="tl-tracks" id="tlTracks"></div></div>
  <div class="tl-legend"><div class="tl-legend-item"><span class="tl-legend-dot lg-run"></span> ì‹¤í–‰ ì¤‘</div><div class="tl-legend-item"><span class="tl-legend-dot lg-sched"></span> ì˜ˆì •</div><div class="tl-legend-item"><span class="tl-legend-dot lg-one"></span> 1íšŒ</div><div class="tl-legend-item"><span class="tl-legend-dot lg-overlap"></span> ê²¹ì¹¨ êµ¬ê°„</div></div></div>
</div>
<div class="tl-tooltip" id="tooltip"></div>

<div class="header">
  <h1>ì‹œìŠ¤í…œ ìŠ¤ì¼€ì¤„ëŸ¬</h1>
  <div class="header-actions" id="headerActions">
    <button class="hdr-btn" id="btnDel"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M14.5 3V4H20V5.7H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V5.7H4V4H9.5V3H14.5ZM6.7 19.3H17.3V5.7H6.7V19.3ZM9 9H10.7V16H9V9ZM15 9H13.3V16H15V9Z" fill="currentColor"/></svg></button>
    <button class="hdr-btn" id="btnEdit"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M16.4124 5.75744C16.8218 5.37069 17.4904 5.37069 17.8997 5.75744L19.133 6.92272C19.5402 7.30268 19.5455 7.9431 19.1366 8.32457L17.6997 9.68213L14.9765 7.10931L16.4124 5.75744ZM13.8764 8.14506L13.826 8.19247L4.5531 16.962V19.5326H7.2737L16.6014 10.7197L13.8764 8.14506ZM18.9979 4.71984C17.9822 3.76018 16.3305 3.76005 15.3146 4.71947L12.7285 7.15421L3 16.3546V21H7.91701L20.2296 9.36705C21.2568 8.40694 21.2568 6.84361 20.2295 5.8835L18.9979 4.71984Z" fill="currentColor"/></svg></button>
    <button class="hdr-btn" id="btnAdd" style="font-size:18px">ï¼‹</button>
  </div>
</div>

<div class="stats">
  <div class="stat-chip active" onclick="filterCards('all',this)"><span class="num">6</span> ì „ì²´</div>
  <div class="stat-chip" onclick="filterCards('running',this)"><span class="num" style="color:var(--primary)">1</span> ì‹¤í–‰ ì¤‘</div>
  <div class="stat-chip" onclick="filterCards('scheduled',this)"><span class="num" style="color:var(--sched)">4</span> ëŒ€ê¸°</div>
  <div class="stat-chip" onclick="filterCards('oneshot',this)"><span class="num" style="color:var(--accent)">1</span> 1íšŒì„±</div>
</div>

<div class="routine-list" id="routineList">
  <div class="empty-state" id="emptyState"><div class="empty-state-icon">ğŸ“‹</div><div class="empty-state-title">ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤</div><div class="empty-state-desc">ìš°ì¸¡ ìƒë‹¨ ï¼‹ ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ë£¨í‹´ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</div></div>

  <div class="routine-card-wrap" draggable="true">
  <div class="outer-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</div>
  <div class="routine-card" id="card1" data-status="scheduled">
    <div class="bulk-check" onclick="toggleBulkCheck(this)"><span>âœ“</span></div>
    <div class="swipe-wrapper"><div class="swipe-bg">ì‚­ì œ</div><div class="swipe-inner">
    <div class="card-top"><div class="card-meta"><span class="priority-num">1</span><span class="status-badge scheduled">ëŒ€ê¸° ì¤‘</span><span class="type-badge">ë§¤ì£¼</span></div><button class="card-toggle on" onclick="this.classList.toggle('on')"></button></div>
    <div class="card-body" onclick="toggleActions('card1')">
      <div class="schedule-row"><div class="schedule-info"><div class="day-pills"><span class="day-pill active">ì¼</span><span class="day-pill">ì›”</span><span class="day-pill">í™”</span><span class="day-pill">ìˆ˜</span><span class="day-pill">ëª©</span><span class="day-pill">ê¸ˆ</span><span class="day-pill">í† </span></div></div><div class="schedule-info"><div class="time-range">04:00</div></div></div>
      <div class="action-summary"><span class="summary-text"><strong>ì¬ì‹œì‘ ì‹¤í–‰</strong></span><span class="count-badge">1ê±´</span><span class="chevron">â–¼</span></div>
      <div class="action-detail"><div class="compact-list"><div class="compact-item"><span class="compact-dot" style="background:var(--primary)"></span>ì¬ì‹œì‘<span class="compact-action">ì‹¤í–‰</span></div></div></div>
    </div>
    <div class="card-footer"><span>ë‹¤ìŒ ì‹¤í–‰: ì¼ìš”ì¼ 04:00</span></div>
    </div></div>
  </div>
  </div>

  <div class="routine-card-wrap" draggable="true">
  <div class="outer-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</div>
  <div class="routine-card" id="card2" data-status="running">
    <div class="bulk-check" onclick="toggleBulkCheck(this)"><span>âœ“</span></div>
    <div class="swipe-wrapper"><div class="swipe-bg">ì‚­ì œ</div><div class="swipe-inner">
    <div class="card-top"><div class="card-meta"><span class="priority-num">2</span><span class="status-badge running">ì‹¤í–‰ ì¤‘</span><span class="type-badge">ë‚ ì§œ/ì‹œê°„</span></div><button class="card-toggle on" onclick="this.classList.toggle('on')"></button></div>
    <div class="card-body" onclick="toggleActions('card2')">
      <div class="schedule-row"><div class="schedule-info"><div class="time-range" style="font-weight:600">2026-02-26 &nbsp; 08:00 ë¶€í„°</div></div></div>
      <div class="action-summary"><span class="summary-text"><strong>PPTP ì„œë²„ í™œì„±í™”</strong>, <strong>L2TP ì„œë²„ í™œì„±í™”</strong> ì™¸ 2ê±´</span><span class="count-badge">4ê±´</span><span class="chevron">â–¼</span></div>
      <div class="action-detail"><div class="compact-list"><div class="compact-item"><span class="compact-dot" style="background:var(--primary)"></span>PPTP ì„œë²„<span class="compact-action">í™œì„±í™”</span></div><div class="compact-item"><span class="compact-dot" style="background:var(--primary)"></span>L2TP ì„œë²„<span class="compact-action">í™œì„±í™”</span></div><div class="compact-item"><span class="compact-dot" style="background:#c9cdd4"></span>WireGuard ì„œë²„<span class="compact-action">í™œì„±í™”</span></div><div class="compact-item"><span class="compact-dot" style="background:#c9cdd4"></span>ê²Œì´ë° VPN<span class="compact-action">í™œì„±í™”</span></div></div></div>
    </div>
    <div class="card-footer"><span>2/26 08:00ë¶€í„° ê³„ì† ì‹¤í–‰</span></div>
    </div></div>
  </div>
  </div>

  <div class="routine-card-wrap" draggable="true">
  <div class="outer-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</div>
  <div class="routine-card" id="card4" data-status="oneshot">
    <div class="bulk-check" onclick="toggleBulkCheck(this)"><span>âœ“</span></div>
    <div class="swipe-wrapper"><div class="swipe-bg">ì‚­ì œ</div><div class="swipe-inner">
    <div class="card-top"><div class="card-meta"><span class="priority-num">3</span><span class="status-badge oneshot">1íšŒ ì‹¤í–‰</span><span class="type-badge">ë‚ ì§œ/ì‹œê°„</span></div><button class="card-toggle on" onclick="this.classList.toggle('on')"></button></div>
    <div class="card-body" onclick="toggleActions('card4')">
      <div class="schedule-row"><div class="schedule-info"><div class="time-range" style="font-weight:600">2026-02-27 &nbsp; 03:00</div></div></div>
      <div class="action-summary"><span class="summary-text"><strong>íŒì›¨ì–´ ì—…ê·¸ë ˆì´ë“œ ì‹¤í–‰</strong></span><span class="count-badge">1ê±´</span><span class="chevron">â–¼</span></div>
      <div class="action-detail"><div class="compact-list"><div class="compact-item"><span class="compact-dot" style="background:var(--primary)"></span>íŒì›¨ì–´ ì—…ê·¸ë ˆì´ë“œ<span class="compact-action">ì‹¤í–‰</span></div></div></div>
    </div>
    <div class="card-footer"><span>2/27 03:00 ì‹¤í–‰ í›„ ìë™ ì‚­ì œ</span></div>
    </div></div>
  </div>
  </div>

  <div class="routine-card-wrap" draggable="true">
  <div class="outer-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</div>
  <div class="routine-card" id="card5" data-status="scheduled">
    <div class="bulk-check" onclick="toggleBulkCheck(this)"><span>âœ“</span></div>
    <div class="swipe-wrapper"><div class="swipe-bg">ì‚­ì œ</div><div class="swipe-inner">
    <div class="card-top"><div class="card-meta"><span class="priority-num">4</span><span class="status-badge scheduled">ëŒ€ê¸° ì¤‘</span><span class="type-badge">ë§¤ì›”</span></div><button class="card-toggle on" onclick="this.classList.toggle('on')"></button></div>
    <div class="card-body" onclick="toggleActions('card5')">
      <div class="schedule-row"><div class="schedule-info"><div class="time-range">ë§¤ì›” 1, 10, 20ì¼ &nbsp; 05:00</div></div></div>
      <div class="action-summary"><span class="summary-text"><strong>ì¬ì‹œì‘ ì‹¤í–‰</strong></span><span class="count-badge">1ê±´</span><span class="chevron">â–¼</span></div>
      <div class="action-detail"><div class="compact-list"><div class="compact-item"><span class="compact-dot" style="background:var(--primary)"></span>ì¬ì‹œì‘<span class="compact-action">ì‹¤í–‰</span></div></div></div>
    </div>
    <div class="card-footer"><span>ë‹¤ìŒ ì‹¤í–‰: 3/1 05:00</span></div>
    </div></div>
  </div>
  </div>

  <div class="routine-card-wrap" draggable="true">
  <div class="outer-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</div>
  <div class="routine-card" id="card6" data-status="scheduled">
    <div class="bulk-check" onclick="toggleBulkCheck(this)"><span>âœ“</span></div>
    <div class="swipe-wrapper"><div class="swipe-bg">ì‚­ì œ</div><div class="swipe-inner">
    <div class="card-top"><div class="card-meta"><span class="priority-num">5</span><span class="status-badge scheduled">ëŒ€ê¸° ì¤‘</span><span class="type-badge">ë§¤ì£¼</span></div><button class="card-toggle on" onclick="this.classList.toggle('on')"></button></div>
    <div class="card-body" onclick="toggleActions('card6')">
      <div class="schedule-row"><div class="schedule-info"><div class="card-day-bar"><span class="active">ì¼</span><span>ì›”</span><span class="active">í™”</span><span>ìˆ˜</span><span class="active">ëª©</span><span>ê¸ˆ</span><span class="active">í† </span></div></div><div class="schedule-info"><div class="time-range">18:00</div></div></div>
      <div class="action-summary"><span class="summary-text"><strong>ì‹œìŠ¤í…œ ë¡œê·¸ ë©”ì¼ ì „ì†¡ ì‹¤í–‰</strong></span><span class="count-badge">1ê±´</span><span class="chevron">â–¼</span></div>
      <div class="action-detail"><div class="compact-list"><div class="compact-item"><span class="compact-dot" style="background:var(--primary)"></span>ì‹œìŠ¤í…œ ë¡œê·¸ ë©”ì¼ ì „ì†¡<span class="compact-action">ì‹¤í–‰</span></div></div></div>
    </div>
    <div class="card-footer"><span>ë‹¤ìŒ ì‹¤í–‰: ëª©ìš”ì¼ 18:00</span></div>
    </div></div>
  </div>
  </div>

  <div class="routine-card-wrap" draggable="true">
  <div class="outer-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</div>
  <div class="routine-card disabled-svc" id="card3" data-status="scheduled">
    <div class="bulk-check" onclick="toggleBulkCheck(this)"><span>âœ“</span></div>
    <div class="swipe-wrapper"><div class="swipe-bg">ì‚­ì œ</div><div class="swipe-inner">
    <div class="card-top"><div class="card-meta"><span class="priority-num">6</span><span class="status-badge scheduled">ëŒ€ê¸° ì¤‘</span><span class="type-badge">ë§¤ì£¼</span></div><button class="card-toggle" onclick="this.classList.toggle('on')"></button></div>
    <div class="svc-warn"><span class="svc-warn-dot"></span>ìœˆë„ìš° íŒŒì¼ê³µìœ : USB ë¯¸ì—°ê²°</div>
    <div class="card-body" onclick="toggleActions('card3')">
      <div class="schedule-row"><div class="schedule-info"><div class="day-pills"><span class="day-pill">ì¼</span><span class="day-pill active">ì›”</span><span class="day-pill active">í™”</span><span class="day-pill active">ìˆ˜</span><span class="day-pill active">ëª©</span><span class="day-pill active">ê¸ˆ</span><span class="day-pill">í† </span></div></div><div class="schedule-info"><div class="time-range">08:00 <span style="color:#9ca3af">~</span> 22:00</div></div></div>
      <div class="action-summary"><span class="summary-text"><strong>ìœˆë„ìš° íŒŒì¼ê³µìœ  í™œì„±í™”</strong></span><span class="count-badge">1ê±´</span><span class="chevron">â–¼</span></div>
      <div class="action-detail"><div class="compact-list"><div class="compact-item"><span class="compact-dot" style="background:#c9cdd4"></span>ìœˆë„ìš° íŒŒì¼ê³µìœ <span class="compact-action">í™œì„±í™”</span></div></div></div>
    </div>
    <div class="card-footer"><span>ì„œë¹„ìŠ¤ ì‚¬ìš© ë¶ˆê°€ë¡œ ì‹¤í–‰ ë³´ë¥˜</span></div>
    </div></div>
  </div>
  </div>
</div>

<div class="overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header"><h2 id="modalTitle">ìŠ¤ì¼€ì¤„ëŸ¬ ì¶”ê°€</h2><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="modal-grid">
        <div>
          <div class="section-title">ì–¸ì œ</div>
          <div class="tab-group">
            <button class="tab-btn active" id="tabSchedule" onclick="switchWhen('schedule',this)">ë°˜ë³µ</button>
            <button class="tab-btn" id="tabDatetime" onclick="switchWhen('datetime',this)">ë‚ ì§œ/ì‹œê°„</button>
          </div>
          <div id="panelSchedule">
            <div class="repeat-tabs" id="repeatTabs">
              <button class="repeat-tab active" onclick="switchRepeat('weekly',this)">ë§¤ì£¼</button>
              <button class="repeat-tab" onclick="switchRepeat('monthly',this)">ë§¤ì›”</button>
            </div>
            <div id="panelWeekly">
              <div class="form-label" style="margin-bottom:6px">ìš”ì¼</div>
              <div class="day-presets" id="dayPresets">
                <button class="day-preset-btn" onclick="applyPreset('weekdays',this)">í‰ì¼</button>
                <button class="day-preset-btn" onclick="applyPreset('weekend',this)">ì£¼ë§</button>
                <button class="day-preset-btn" onclick="applyPreset('everyday',this)">ë§¤ì¼</button>
              </div>
              <div class="day-selector" id="daySelector"></div>
            </div>
            <div id="panelMonthly" style="display:none">
              <div class="form-label" style="margin-bottom:6px">ë‚ ì§œ</div>
              <div class="date-presets" id="datePresets">
                <button class="date-preset-btn" onclick="applyDatePreset('first',this)">ë§¤ì›” 1ì¼</button>
                <button class="date-preset-btn" onclick="applyDatePreset('mid',this)">ë§¤ì›” 15ì¼</button>
                <button class="date-preset-btn" onclick="applyDatePreset('firstlast',this)">1ì¼ &amp; ë§ì¼</button>
              </div>
              <div class="date-grid" id="dateGrid"></div>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <span class="form-label" style="margin:0">ì‹œê°„</span>
              <label id="allDayLabel" style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--ts);user-select:none">
                <input type="checkbox" id="allDayCheck" onchange="toggleAllDay()" style="accent-color:var(--primary)"> ì¢…ì¼
              </label>
            </div>
            <div class="time-inputs" id="timeInputsWrap"><div class="time-input-wrap"><label>ì‹œì‘</label><input type="time" class="time-input" id="timeStart" oninput="updateSummary()" style="display:none"><div class="ctp-wrap"><div class="ctp-trigger" id="ctpStartTrigger" onclick="toggleCtp('start')">--:--</div><div class="ctp-panel" id="ctpStartPanel"></div></div></div><div class="time-sep">~</div><div class="time-input-wrap"><label>ì¢…ë£Œ</label><input type="time" class="time-input" id="timeEnd" oninput="updateSummary()" style="display:none"><div class="ctp-wrap"><div class="ctp-trigger" id="ctpEndTrigger" onclick="toggleCtp('end')">--:--</div><div class="ctp-panel" id="ctpEndPanel"></div></div></div></div>
            <div id="allDayMsg" style="display:none;padding:10px 12px;background:#f9fafb;border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--ts);text-align:center">â° í•´ë‹¹ ì¼ì ì „ì²´ì— ì ìš©ë©ë‹ˆë‹¤</div>
          </div>
          <div id="panelDatetime" style="display:none">
            <div class="form-label" style="margin-bottom:6px">ë‚ ì§œ ë° ì‹œê°„</div>
            <input type="datetime-local" class="datetime-input" id="dtInput" oninput="updateSummary()" style="display:none">
            <div class="cdtp-wrap"><div class="cdtp-trigger" id="cdtpTrigger" onclick="toggleCdtp()"><span class="placeholder">ë‚ ì§œ ë° ì‹œê°„ ì„ íƒ...</span></div><div class="cdtp-panel" id="cdtpPanel"></div></div>
            <div class="form-label" style="margin-bottom:6px">ì‹¤í–‰ ê¸°ì¤€</div>
            <div class="timing-mode" id="timingMode">
              <button class="timing-btn" onclick="selTiming(this)" data-val="ê¹Œì§€">~ê¹Œì§€</button>
              <button class="timing-btn active" onclick="selTiming(this)" data-val="ì •ì‹œì—">ì¦‰ì‹œ 1íšŒ</button>
              <button class="timing-btn" onclick="selTiming(this)" data-val="ë¶€í„°">~ë¶€í„° ê³„ì†</button>
            </div>
          </div>
          <div class="schedule-summary empty" id="scheduleSummary">
            <span class="schedule-summary-icon">ğŸ“…</span>
            <span class="schedule-summary-text" id="summaryText">ì„¤ì •ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤</span>
          </div>
        </div>
        <div>
          <div class="section-title">ë¬´ì—‡ì„</div>
          <div id="actionsList"></div>
          <button class="add-action-btn" onclick="addAction()">ï¼‹ ì‘ì—… ì¶”ê°€</button>
          <div class="oneshot-toggle" onclick="toggleOneshot()"><div class="check-box" id="osCheck"><span style="display:none">âœ“</span></div><span class="oneshot-label">í•œë²ˆë§Œ ì‹¤í–‰ í›„ ì‚­ì œ</span></div>
        </div>
      </div>
    </div>
    <div class="modal-footer"><span class="modal-error" id="modalError"></span><div style="display:flex;gap:10px"><button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button><button class="btn-save" id="saveBtn" onclick="validateAndSave()">ì €ì¥</button></div></div>
  </div>
</div>

<script>
var SVG_DEL='<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M14.5 3V4H20V5.7H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V5.7H4V4H9.5V3H14.5ZM6.7 19.3H17.3V5.7H6.7V19.3ZM9 9H10.7V16H9V9ZM15 9H13.3V16H15V9Z" fill="currentColor"/></svg>';
var SVG_DEL_W='<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M14.5 3V4H20V5.7H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V5.7H4V4H9.5V3H14.5ZM6.7 19.3H17.3V5.7H6.7V19.3ZM9 9H10.7V16H9V9ZM15 9H13.3V16H15V9Z" fill="#fff"/></svg>';
var SVG_EDIT='<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M16.4124 5.75744C16.8218 5.37069 17.4904 5.37069 17.8997 5.75744L19.133 6.92272C19.5402 7.30268 19.5455 7.9431 19.1366 8.32457L17.6997 9.68213L14.9765 7.10931L16.4124 5.75744ZM13.8764 8.14506L13.826 8.19247L4.5531 16.962V19.5326H7.2737L16.6014 10.7197L13.8764 8.14506ZM18.9979 4.71984C17.9822 3.76018 16.3305 3.76005 15.3146 4.71947L12.7285 7.15421L3 16.3546V21H7.91701L20.2296 9.36705C21.2568 8.40694 21.2568 6.84361 20.2295 5.8835L18.9979 4.71984Z" fill="currentColor"/></svg>';

var $del=document.getElementById('btnDel');
var $edit=document.getElementById('btnEdit');
var $add=document.getElementById('btnAdd');

/* ===== í—¤ë” ë²„íŠ¼ ëª¨ë“œ ===== */
function setDefaultMode(){
  $del.style.display='';$del.className='hdr-btn';$del.innerHTML=SVG_DEL;$del.onclick=startDeleteMode;
  $edit.style.display='';$edit.className='hdr-btn';$edit.innerHTML=SVG_EDIT;$edit.onclick=startEditMode;
  $add.style.display='';$add.className='hdr-btn';$add.innerHTML='ï¼‹';$add.style.fontSize='18px';$add.onclick=function(){openModal('add')};
}

function startDeleteMode(){
  bulkMode=true;
  $del.innerHTML='âœ•';$del.onclick=cancelDeleteMode;
  $edit.style.display='none';
  $add.className='hdr-btn green disabled';$add.innerHTML=SVG_DEL_W;$add.onclick=confirmBulkDelete;
  document.querySelectorAll('.routine-card').forEach(function(c){c.classList.add('bulk-mode');c.setAttribute('draggable','false')});
  document.querySelectorAll('.outer-drag-handle').forEach(function(h){h.style.visibility='hidden'});
}

function cancelDeleteMode(){
  bulkMode=false;
  setDefaultMode();
  document.querySelectorAll('.routine-card').forEach(function(c){c.classList.remove('bulk-mode','bulk-selected');c.setAttribute('draggable','true');var ck=c.querySelector('.bulk-check');if(ck)ck.classList.remove('checked')});
  document.querySelectorAll('.outer-drag-handle').forEach(function(h){h.style.visibility=''});
}

var editMode=false;
function startEditMode(){
  editMode=true;
  $del.style.display='none';
  $edit.innerHTML='âœ•';$edit.onclick=function(){cancelEditMode()};
  $add.style.display='none';
  document.querySelectorAll('.routine-card').forEach(function(c){c.classList.add('edit-mode')});
  document.querySelectorAll('.routine-card-wrap').forEach(function(w){w.setAttribute('draggable','false')});
  document.querySelectorAll('.outer-drag-handle').forEach(function(h){h.style.visibility='hidden'});
}
function cancelEditMode(){
  editMode=false;
  setDefaultMode();
  document.querySelectorAll('.routine-card').forEach(function(c){c.classList.remove('edit-mode')});
  document.querySelectorAll('.routine-card-wrap').forEach(function(w){w.setAttribute('draggable','true')});
  document.querySelectorAll('.outer-drag-handle').forEach(function(h){h.style.visibility=''});
}

setDefaultMode();

/* ===== í¸ì§‘ ì•„ì´ì½˜ ì‚½ì… ===== */
var SVG_EDIT_SMALL='<svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M16.4124 5.75744C16.8218 5.37069 17.4904 5.37069 17.8997 5.75744L19.133 6.92272C19.5402 7.30268 19.5455 7.9431 19.1366 8.32457L17.6997 9.68213L14.9765 7.10931L16.4124 5.75744ZM13.8764 8.14506L13.826 8.19247L4.5531 16.962V19.5326H7.2737L16.6014 10.7197L13.8764 8.14506ZM18.9979 4.71984C17.9822 3.76018 16.3305 3.76005 15.3146 4.71947L12.7285 7.15421L3 16.3546V21H7.91701L20.2296 9.36705C21.2568 8.40694 21.2568 6.84361 20.2295 5.8835L18.9979 4.71984Z" fill="currentColor"/></svg>';
document.querySelectorAll('.routine-card').forEach(function(c){var ei=document.createElement('div');ei.className='edit-icon';ei.innerHTML=SVG_EDIT_SMALL;c.insertBefore(ei,c.firstChild)});

/* ===== ì„œë¹„ìŠ¤ ëª©ë¡ ===== */
var svcList=[
  {key:'reboot',name:'ì¬ì‹œì‘',actions:['ì‹¤í–‰'],targets:[],group:'ì‹œìŠ¤í…œ',status:'ready',statusText:'í•­ìƒ ì‚¬ìš© ê°€ëŠ¥'},
  {key:'fw',name:'íŒì›¨ì–´ ì—…ê·¸ë ˆì´ë“œ',actions:['ì‹¤í–‰'],targets:[],group:'ì‹œìŠ¤í…œ',status:'ready',statusText:'ìµœì‹  ë²„ì „ í™•ì¸ë¨'},
  {key:'syslog_mail',name:'ì‹œìŠ¤í…œ ë¡œê·¸ ë©”ì¼ ì „ì†¡',actions:['ì‹¤í–‰'],targets:[],group:'ì‹œìŠ¤í…œ',status:'ready',statusText:'ë©”ì¼ ì„œë²„ ì„¤ì •ë¨'},
  {key:'pptp',name:'PPTP ì„œë²„',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'VPN ì„œë²„',status:'ready',statusText:'ì„¤ì • ì™„ë£Œ'},
  {key:'l2tp',name:'L2TP ì„œë²„',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'VPN ì„œë²„',status:'ready',statusText:'ì„¤ì • ì™„ë£Œ'},
  {key:'wg_server',name:'WireGuard ì„œë²„',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'VPN ì„œë²„',status:'unavail',statusText:'í”¼ì–´ ë¯¸ì„¤ì •'},
  {key:'gaming_vpn',name:'ê²Œì´ë° VPN',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'VPN ì„œë²„',status:'unavail',statusText:'ë¯¸ì§€ì› ëª¨ë¸'},
  {key:'usb_ftp',name:'FTP',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'USB ì„œë¹„ìŠ¤',status:'unavail',statusText:'USB ë¯¸ì—°ê²°'},
  {key:'usb_smb',name:'ìœˆë„ìš° íŒŒì¼ê³µìœ ',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'USB ì„œë¹„ìŠ¤',status:'unavail',statusText:'USB ë¯¸ì—°ê²°'},
  {key:'usb_dlna',name:'ë¯¸ë””ì–´ ì„œë²„',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'USB ì„œë¹„ìŠ¤',status:'unavail',statusText:'USB ë¯¸ì—°ê²°'},
  {key:'usb_torrent',name:'í† ë ŒíŠ¸',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'USB ì„œë¹„ìŠ¤',status:'unavail',statusText:'USB ë¯¸ì—°ê²°'},
  {key:'usb_cloud_backup',name:'Cloud ë°±ì—…',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'USB ì„œë¹„ìŠ¤',status:'unavail',statusText:'ì„œë¹„ìŠ¤ ì¢…ë£Œ'},
  {key:'usb_iptime_cloud',name:'ipTIME Cloud',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'USB ì„œë¹„ìŠ¤',status:'unavail',statusText:'ê³„ì • ë¯¸ì—°ê²°'},
  {key:'usb_url',name:'URL ì„œë¹„ìŠ¤',actions:['í™œì„±í™”','ë¹„í™œì„±í™”'],targets:[],group:'USB ì„œë¹„ìŠ¤',status:'unavail',statusText:'ë¯¸ì„¤ì •'}
];
var svcNames={},svcConfig={};
svcList.forEach(function(s){svcNames[s.key]=s.name;svcConfig[s.key]={actions:s.actions,targets:s.targets,hasTarget:s.targets.length>0,status:s.status,statusText:s.statusText}});

var routineData=[
  {id:1,whenType:'schedule',repeatMode:'weekly',days:[0],dates:[],timeStart:'04:00',timeEnd:'',_allDay:false,actions:[{service:'reboot',action:'ì‹¤í–‰',target:''}],oneshot:false,timing:'ì •ì‹œì—',datetime:''},
  {id:2,whenType:'datetime',repeatMode:'weekly',days:[],dates:[],timeStart:'',timeEnd:'',actions:[{service:'pptp',action:'í™œì„±í™”',target:''},{service:'l2tp',action:'í™œì„±í™”',target:''},{service:'wg_server',action:'í™œì„±í™”',target:''},{service:'gaming_vpn',action:'í™œì„±í™”',target:''}],oneshot:false,timing:'ë¶€í„°',datetime:'2026-02-26T08:00'},
  {id:3,whenType:'schedule',repeatMode:'weekly',days:[1,2,3,4,5],dates:[],timeStart:'08:00',timeEnd:'22:00',actions:[{service:'usb_smb',action:'í™œì„±í™”',target:''}],oneshot:false,timing:'ì •ì‹œì—',datetime:''},
  {id:4,whenType:'datetime',repeatMode:'weekly',days:[],dates:[],timeStart:'',timeEnd:'',actions:[{service:'fw',action:'ì‹¤í–‰',target:''}],oneshot:true,timing:'ì •ì‹œì—',datetime:'2026-02-27T03:00'},
  {id:5,whenType:'schedule',repeatMode:'monthly',days:[],dates:['1','10','20'],timeStart:'05:00',timeEnd:'',_allDay:false,actions:[{service:'reboot',action:'ì‹¤í–‰',target:''}],oneshot:false,timing:'ì •ì‹œì—',datetime:''},
  {id:6,whenType:'schedule',repeatMode:'weekly',days:[0,2,4,6],dates:[],timeStart:'18:00',timeEnd:'',_allDay:false,actions:[{service:'syslog_mail',action:'ì‹¤í–‰',target:''}],oneshot:false,timing:'ì •ì‹œì—',datetime:''}
];
var dayLabels=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
var curRepeatMode='weekly';

function buildDateGrid(){var g=document.getElementById('dateGrid');g.innerHTML='';for(var d=1;d<=31;d++){var b=document.createElement('button');b.className='date-cell';b.textContent=d;b.dataset.date=d;b.onclick=function(){this.classList.toggle('selected');syncDatePresetHighlight();updateSummary()};g.appendChild(b)}var last=document.createElement('button');last.className='date-cell last-day';last.textContent='ë§ì¼';last.dataset.date='last';last.onclick=function(){this.classList.toggle('selected');syncDatePresetHighlight();updateSummary()};g.appendChild(last)}
buildDateGrid();
function getSelectedDates(){var sel=[];document.querySelectorAll('#dateGrid .date-cell.selected').forEach(function(c){sel.push(c.dataset.date)});return sel}
function setSelectedDates(arr){document.querySelectorAll('#dateGrid .date-cell').forEach(function(c){c.classList.toggle('selected',arr.includes(c.dataset.date)||arr.includes(parseInt(c.dataset.date)))})}
function applyDatePreset(key,btn){var btns=document.querySelectorAll('#datePresets .date-preset-btn');var wasActive=btn.classList.contains('active');btns.forEach(function(b){b.classList.remove('active')});document.querySelectorAll('#dateGrid .date-cell').forEach(function(c){c.classList.remove('selected')});if(!wasActive){btn.classList.add('active');if(key==='first')setSelectedDates(['1']);else if(key==='mid')setSelectedDates(['15']);else if(key==='firstlast')setSelectedDates(['1','last'])}updateSummary()}
function syncDatePresetHighlight(){var sel=getSelectedDates();var btns=document.querySelectorAll('#datePresets .date-preset-btn');btns.forEach(function(b){b.classList.remove('active')});var s=sel.sort().join(',');if(s==='1')btns[0].classList.add('active');else if(s==='15')btns[1].classList.add('active');else if(s==='1,last')btns[2].classList.add('active')}
function switchRepeat(mode,btn){curRepeatMode=mode;document.querySelectorAll('#repeatTabs .repeat-tab').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');document.getElementById('panelWeekly').style.display=mode==='weekly'?'':'none';document.getElementById('panelMonthly').style.display=mode==='monthly'?'':'none';updateSummary()}

var presets={weekdays:[1,2,3,4,5],weekend:[0,6],everyday:[0,1,2,3,4,5,6]};
function applyPreset(key,btn){var btns=document.querySelectorAll('#dayPresets .day-preset-btn');var wasActive=btn.classList.contains('active');btns.forEach(function(b){b.classList.remove('active')});var dayBtns=document.querySelectorAll('#daySelector .day-btn');if(wasActive){dayBtns.forEach(function(b){b.classList.remove('selected')})}else{btn.classList.add('active');var sel=presets[key];dayBtns.forEach(function(b,i){b.classList.toggle('selected',sel.includes(i))})}updateSummary()}
function syncPresetHighlight(){var sel=[];document.querySelectorAll('#daySelector .day-btn').forEach(function(b,i){if(b.classList.contains('selected'))sel.push(i)});var btns=document.querySelectorAll('#dayPresets .day-preset-btn');btns.forEach(function(b){b.classList.remove('active')});var s=sel.slice().sort().join(',');if(s===presets.weekdays.slice().sort().join(','))btns[0].classList.add('active');else if(s===presets.weekend.slice().sort().join(','))btns[1].classList.add('active');else if(s===presets.everyday.slice().sort().join(','))btns[2].classList.add('active')}

function updateSummary(){
  var wrap=document.getElementById('scheduleSummary'),txt=document.getElementById('summaryText'),icon=wrap.querySelector('.schedule-summary-icon');
  var isSchedule=document.getElementById('tabSchedule').classList.contains('active');
  if(isSchedule){
    var allDay=document.getElementById('allDayCheck').checked,ts=document.getElementById('timeStart').value,te=document.getElementById('timeEnd').value,locked=checkAllOneshot();
    var timeStr='';
    if(locked){timeStr=ts?ts+' ì‹¤í–‰':'<span class="summary-dim">ì‹¤í–‰ ì‹œê° ë¯¸ì„¤ì •</span>'}
    else if(allDay)timeStr='ì¢…ì¼';else if(ts&&te)timeStr=ts+' ~ '+te;else if(ts)timeStr=ts+' ì •ì‹œì— ì‹¤í–‰';else timeStr='<span class="summary-dim">ì‹œê°„ ë¯¸ì„¤ì •</span>';
    if(curRepeatMode==='weekly'){
      var sel=[];document.querySelectorAll('#daySelector .day-btn').forEach(function(b,i){if(b.classList.contains('selected'))sel.push(i)});
      if(sel.length===0){wrap.classList.add('empty');icon.textContent='ğŸ“…';txt.innerHTML='ìš”ì¼ê³¼ ì‹œê°„ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤';return}
      wrap.classList.remove('empty');icon.textContent='ğŸ”';
      var s=sel.slice().sort().join(','),dayStr='';
      if(s===presets.everyday.slice().sort().join(','))dayStr='ë§¤ì¼';else if(s===presets.weekdays.slice().sort().join(','))dayStr='í‰ì¼(ì›”~ê¸ˆ)';else if(s===presets.weekend.slice().sort().join(','))dayStr='ì£¼ë§(í† Â·ì¼)';else dayStr='ë§¤ì£¼ '+sel.map(function(i){return dayLabels[i]}).join('Â·');
      txt.innerHTML='<span class="summary-highlight">'+dayStr+'</span> '+timeStr;
    }else{
      var dates=getSelectedDates();
      if(dates.length===0){wrap.classList.add('empty');icon.textContent='ğŸ“…';txt.innerHTML='ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤';return}
      wrap.classList.remove('empty');icon.textContent='ğŸ“†';
      var dateStr=dates.map(function(d){return d==='last'?'ë§ì¼':d+'ì¼'}).join(', ');
      txt.innerHTML='<span class="summary-highlight">ë§¤ì›” '+dateStr+'</span> '+timeStr;
    }
  }else{
    var dt=document.getElementById('dtInput').value;
    if(!dt){wrap.classList.add('empty');icon.textContent='ğŸ“…';txt.innerHTML='ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤';return}
    wrap.classList.remove('empty');
    var timing='';document.getElementById('timingMode').querySelectorAll('.timing-btn').forEach(function(b){if(b.classList.contains('active'))timing=b.dataset.val});
    var d=new Date(dt),mon=d.getMonth()+1,day=d.getDate(),hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0'),dow=dayLabels[d.getDay()];
    var dateStr2=mon+'/'+day+' ('+dow+') '+hh+':'+mm;
    if(timing==='ì •ì‹œì—'){icon.textContent='âš¡';txt.innerHTML='<span class="summary-highlight">'+dateStr2+'</span>ì— <span class="summary-highlight">1íšŒ</span> ì‹¤í–‰'}
    else if(timing==='ê¹Œì§€'){icon.textContent='â³';txt.innerHTML='ì§€ê¸ˆë¶€í„° â†’ <span class="summary-highlight">'+dateStr2+'</span>ê¹Œì§€ ì‹¤í–‰'}
    else{icon.textContent='â–¶ï¸';txt.innerHTML='<span class="summary-highlight">'+dateStr2+'</span>ë¶€í„° ê³„ì† ì‹¤í–‰'}
  }
}

function toggleActions(id){
  if(editMode){var idMap={card1:1,card2:2,card3:3,card4:4,card5:5,card6:6};var rid=idMap[id];if(rid){openModal('edit',rid);cancelEditMode()}return}
  var c=document.getElementById(id),d=c.querySelector('.action-detail'),ch=c.querySelector('.chevron');d.classList.toggle('open');ch.classList.toggle('open')}
function filterCards(status,chip){document.querySelectorAll('.stat-chip').forEach(function(c){c.classList.remove('active')});chip.classList.add('active');var visible=0;document.querySelectorAll('.routine-card-wrap').forEach(function(wrap){var card=wrap.querySelector('.routine-card');if(!card)return;var show=status==='all'||card.dataset.status===status;wrap.style.display=show?'':'none';if(show)visible++});document.getElementById('emptyState').classList.toggle('show',visible===0);updatePriorityNumbers()}

/* ===== ë“œë˜ê·¸ ===== */
(function(){
  var list=document.getElementById('routineList');var dragEl=null;
  list.addEventListener('dragstart',function(e){var wrap=e.target.closest('.routine-card-wrap');if(!wrap||bulkMode)return;dragEl=wrap;setTimeout(function(){dragEl.classList.add('dragging')},0);e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain','')});
  list.addEventListener('dragover',function(e){e.preventDefault();if(!dragEl)return;var wrap=e.target.closest('.routine-card-wrap');if(!wrap||wrap===dragEl)return;var rect=wrap.getBoundingClientRect();var mid=rect.top+rect.height/2;list.querySelectorAll('.routine-card-wrap').forEach(function(c){c.classList.remove('drag-over-top','drag-over-bottom')});if(e.clientY<mid)wrap.classList.add('drag-over-top');else wrap.classList.add('drag-over-bottom')});
  list.addEventListener('dragleave',function(e){var wrap=e.target.closest('.routine-card-wrap');if(wrap)wrap.classList.remove('drag-over-top','drag-over-bottom')});
  list.addEventListener('drop',function(e){e.preventDefault();if(!dragEl)return;var target=null,insertBefore=true;list.querySelectorAll('.routine-card-wrap').forEach(function(c){if(c.classList.contains('drag-over-top')){target=c;insertBefore=true}if(c.classList.contains('drag-over-bottom')){target=c;insertBefore=false}c.classList.remove('drag-over-top','drag-over-bottom')});if(target&&target!==dragEl){if(insertBefore)list.insertBefore(dragEl,target);else{var next=target.nextElementSibling;if(next)list.insertBefore(dragEl,next);else list.appendChild(dragEl)}}dragEl.classList.remove('dragging');dragEl=null;updatePriorityNumbers()});
  list.addEventListener('dragend',function(){if(dragEl){dragEl.classList.remove('dragging');dragEl=null}list.querySelectorAll('.routine-card-wrap').forEach(function(c){c.classList.remove('drag-over-top','drag-over-bottom')})});
})();
function updatePriorityNumbers(){var wraps=document.querySelectorAll('#routineList .routine-card-wrap');var n=1;wraps.forEach(function(w){var c=w.querySelector('.routine-card');if(!c||w.style.display==='none'||c.style.display==='none')return;var num=c.querySelector('.priority-num');if(num)num.textContent=n++})}

/* ===== ì‚­ì œ ëª¨ë“œ ===== */
var bulkMode=false;
function toggleBulkCheck(el){el.classList.toggle('checked');el.closest('.routine-card').classList.toggle('bulk-selected');updateBulkCount()}
function updateBulkCount(){var n=document.querySelectorAll('.bulk-check.checked').length;if(bulkMode){$add.className=n?'hdr-btn green':'hdr-btn green disabled'}}
function confirmBulkDelete(){document.querySelectorAll('.routine-card.bulk-selected').forEach(function(c){var wrap=c.closest('.routine-card-wrap');if(wrap){wrap.style.transition='all .3s';wrap.style.opacity='0';wrap.style.maxHeight='0';wrap.style.marginBottom='0';wrap.style.overflow='hidden';setTimeout(function(){wrap.remove();checkEmpty();updatePriorityNumbers()},300)}});setTimeout(cancelDeleteMode,350)}
function updateStatCounts(){
  var all=0,running=0,scheduled=0,oneshot=0;
  document.querySelectorAll('.routine-card-wrap').forEach(function(w){if(w.style.display==='none'||w.style.opacity==='0')return;var c=w.querySelector('.routine-card');if(!c)return;all++;var st=c.dataset.status;if(st==='running')running++;else if(st==='scheduled')scheduled++;else if(st==='oneshot')oneshot++});
  var chips=document.querySelectorAll('.stat-chip .num');chips[0].textContent=all;chips[1].textContent=running;chips[2].textContent=scheduled;chips[3].textContent=oneshot;
}
function checkEmpty(){var v=0;document.querySelectorAll('.routine-card-wrap').forEach(function(w){if(w.style.display!=='none'&&w.style.opacity!=='0')v++});document.getElementById('emptyState').classList.toggle('show',!v);updateStatCounts()}

/* ===== ëª¨ë‹¬: ì„œë¹„ìŠ¤ ì„ íƒ ===== */
var openDropdownEl=null;
document.addEventListener('click',function(e){if(openDropdownEl&&!openDropdownEl.closest('.svc-select-wrap').contains(e.target))closeSvcDropdown(openDropdownEl)});
function closeSvcDropdown(dd){if(!dd)return;dd.classList.remove('show');var trigger=dd.previousElementSibling;if(trigger)trigger.classList.remove('open');if(openDropdownEl===dd)openDropdownEl=null}
function toggleSvcDropdown(trigger){var dd=trigger.nextElementSibling;if(dd.classList.contains('show')){closeSvcDropdown(dd)}else{if(openDropdownEl)closeSvcDropdown(openDropdownEl);dd.classList.add('show');trigger.classList.add('open');openDropdownEl=dd}}
function selectSvcItem(item,wrap){
  var key=item.dataset.key;wrap.dataset.selectedKey=key;
  var trigger=wrap.querySelector('.svc-select-trigger');var svc=svcList.find(function(s){return s.key===key});
  var dotColor=svc.status==='ready'?'#22c55e':'#d1d5db';
  trigger.innerHTML='<span class="trigger-dot" style="background:'+dotColor+'"></span><span class="trigger-text">'+svc.name+'</span><span class="trigger-arrow">â€º</span>';
  wrap.querySelectorAll('.svc-dropdown-item').forEach(function(i){i.classList.remove('selected')});item.classList.add('selected');
  closeSvcDropdown(wrap.querySelector('.svc-dropdown'));onSvcCustom(wrap,key);
}
function buildSvcCustomSelect(selected){
  var h='<div class="svc-select-wrap" data-selected-key="'+(selected||'')+'">';
  if(selected){var svc=svcList.find(function(s){return s.key===selected});var dotColor=svc.status==='ready'?'#22c55e':'#d1d5db';h+='<div class="svc-select-trigger" onclick="toggleSvcDropdown(this)"><span class="trigger-dot" style="background:'+dotColor+'"></span><span class="trigger-text">'+svc.name+'</span><span class="trigger-arrow">â€º</span></div>'}
  else{h+='<div class="svc-select-trigger" onclick="toggleSvcDropdown(this)"><span class="trigger-text trigger-placeholder">ì„œë¹„ìŠ¤ ì„ íƒ...</span><span class="trigger-arrow">â€º</span></div>'}
  h+='<div class="svc-dropdown">';
  var groups=[],groupMap={};svcList.forEach(function(s){var g=s.group||'ê¸°íƒ€';if(!groupMap[g]){groupMap[g]=[];groups.push(g)}groupMap[g].push(s)});
  groups.forEach(function(g){
    h+='<div class="svc-dropdown-group"><div class="svc-dropdown-group-label">'+g+'</div>';
    groupMap[g].forEach(function(s){
      var dotClass=s.status==='ready'?'st-ready':'st-unavail';var tagClass=s.status==='ready'?'tag-ready':'tag-unavail';var tagText=s.status==='ready'?'ì‚¬ìš© ê°€ëŠ¥':'ì‚¬ìš© ë¶ˆê°€';
      h+='<div class="svc-dropdown-item'+(selected===s.key?' selected':'')+(s.status!=='ready'?' is-unavail':'')+'" data-key="'+s.key+'" onclick="selectSvcItem(this,this.closest(\'.svc-select-wrap\'))"><span class="item-dot '+dotClass+'"></span><span class="item-name">'+s.name+'</span><span class="item-tag '+tagClass+'">'+tagText+'</span></div>';
    });h+='</div>';
  });h+='</div></div>';return h;
}
function buildSvcStatusRow(svcKey){if(!svcKey)return '';var svc=svcList.find(function(s){return s.key===svcKey});if(!svc||svc.status==='ready')return '';return '<div class="svc-status-row unavail"><span class="svc-status-dot"></span><span class="svc-status-label">'+svc.statusText+'</span><span class="svc-status-tag">ì‚¬ìš© ë¶ˆê°€</span></div>'}
function buildActionItem(a){
  var cfg=a.service?svcConfig[a.service]:null;var hasTargets=cfg&&cfg.hasTarget;
  var svcInfo=a.service?svcList.find(function(s){return s.key===a.service}):null;var groupLabel=svcInfo?svcInfo.group:'';
  var h='<div class="action-item"><div class="action-item-header"><span style="font-size:14px;font-weight:600;color:var(--text)">ì„œë¹„ìŠ¤</span>';
  if(groupLabel)h+='<span class="group-badge" style="font-size:10px;font-weight:600;color:var(--ts);background:#f3f4f6;padding:2px 8px;border-radius:4px;margin-right:auto;margin-left:8px">'+groupLabel+'</span>';
  h+='<button class="action-remove" onclick="rmAction(this)">âœ•</button></div>';
  h+='<div class="form-row svc-row">'+buildSvcCustomSelect(a.service)+'</div>';
  h+='<div class="form-row svc-status-wrap">'+buildSvcStatusRow(a.service)+'</div>';
  var isUnavail=cfg&&cfg.status==='unavail';
  if(hasTargets&&!isUnavail){h+='<div class="form-row target-row"><label class="form-label">ëŒ€ìƒ</label><select class="form-select">';if(cfg.targets.length>0)cfg.targets.forEach(function(t){h+='<option'+(a.target===t?' selected':'')+'>'+t+'</option>'});else h+='<option value="" disabled selected style="color:#9ca3af">ë“±ë¡ëœ ëŒ€ìƒ ì—†ìŒ</option>';h+='</select></div>'}
  if(cfg&&!isUnavail){h+='<div class="form-row action-row"><label class="form-label">ë™ì‘</label><div class="action-btns">';cfg.actions.forEach(function(t){h+='<button class="action-type-btn'+(a.action===t?' selected':'')+'" onclick="selType(this)">'+t+'</button>'});h+='</div></div>'}
  h+='</div>';return h;
}
function selType(b){b.parentElement.querySelectorAll('.action-type-btn').forEach(function(x){x.classList.remove('selected')});b.classList.add('selected');enforceOneshotOnly()}
function onSvcCustom(wrap,svc){
  var item=wrap.closest('.action-item');var cfg=svc?svcConfig[svc]:null;
  var old;old=item.querySelector('.target-row');if(old)old.remove();old=item.querySelector('.action-row');if(old)old.remove();
  var statusWrap=item.querySelector('.svc-status-wrap');if(statusWrap)statusWrap.innerHTML=buildSvcStatusRow(svc);
  var hdr=item.querySelector('.action-item-header');var oldBadge=hdr.querySelector('.group-badge');if(oldBadge)oldBadge.remove();
  if(svc){var info=svcList.find(function(s){return s.key===svc});if(info&&info.group){var badge=document.createElement('span');badge.className='group-badge';badge.style.cssText='font-size:10px;font-weight:600;color:var(--ts);background:#f3f4f6;padding:2px 8px;border-radius:4px;margin-right:auto;margin-left:8px';badge.textContent=info.group;hdr.insertBefore(badge,hdr.querySelector('.action-remove'))}}
  if(!cfg)return;var isUnavail=cfg.status==='unavail';var ins=item.querySelector('.svc-status-wrap');
  if(cfg.hasTarget&&!isUnavail){var t='<div class="form-row target-row"><label class="form-label">ëŒ€ìƒ</label><select class="form-select">';if(cfg.targets.length>0)cfg.targets.forEach(function(x){t+='<option>'+x+'</option>'});else t+='<option value="" disabled selected style="color:#9ca3af">ë“±ë¡ëœ ëŒ€ìƒ ì—†ìŒ</option>';t+='</select></div>';ins.insertAdjacentHTML('afterend',t);ins=ins.nextElementSibling}
  if(!isUnavail){var a='<div class="form-row action-row"><label class="form-label">ë™ì‘</label><div class="action-btns">';cfg.actions.forEach(function(x,i){a+='<button class="action-type-btn'+(i===0?' selected':'')+'" onclick="selType(this)">'+x+'</button>'});a+='</div></div>';ins.insertAdjacentHTML('afterend',a)}
  enforceOneshotOnly();
}

/* ===== ëª¨ë‹¬ ===== */
function populateModal(r){
  if(r.whenType==='schedule'){document.getElementById('tabSchedule').classList.add('active');document.getElementById('tabDatetime').classList.remove('active');document.getElementById('panelSchedule').style.display='';document.getElementById('panelDatetime').style.display='none'}else{document.getElementById('tabDatetime').classList.add('active');document.getElementById('tabSchedule').classList.remove('active');document.getElementById('panelSchedule').style.display='none';document.getElementById('panelDatetime').style.display=''}
  var rm=r.repeatMode||'weekly';curRepeatMode=rm;
  document.querySelectorAll('#repeatTabs .repeat-tab').forEach(function(b){b.classList.remove('active')});
  document.querySelector('#repeatTabs .repeat-tab:nth-child('+(rm==='weekly'?1:2)+')').classList.add('active');
  document.getElementById('panelWeekly').style.display=rm==='weekly'?'':'none';
  document.getElementById('panelMonthly').style.display=rm==='monthly'?'':'none';
  var ds=document.getElementById('daySelector');ds.innerHTML='';
  dayLabels.forEach(function(d,i){ds.innerHTML+='<button class="day-btn'+(r.days.includes(i)?' selected':'')+'" onclick="toggleDay(this)">'+d+'</button>'});
  document.querySelectorAll('#dateGrid .date-cell').forEach(function(c){c.classList.remove('selected')});
  if(r.dates&&r.dates.length){r.dates.forEach(function(d){var cell=document.querySelector('#dateGrid .date-cell[data-date="'+d+'"]');if(cell)cell.classList.add('selected')})}
  var now=new Date();var nowTime=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  document.getElementById('timeStart').value=r.timeStart||nowTime;document.getElementById('timeEnd').value=r.timeEnd||'';
  var isAllDay=r._allDay||false;
  document.getElementById('allDayCheck').checked=isAllDay;document.getElementById('timeInputsWrap').style.display=isAllDay?'none':'';document.getElementById('allDayMsg').style.display=isAllDay?'':'none';
  document.getElementById('dtInput').value=r.datetime||'';
  document.getElementById('timingMode').querySelectorAll('.timing-btn').forEach(function(b){b.classList.remove('active');if(b.dataset.val===r.timing)b.classList.add('active')});
  var al=document.getElementById('actionsList');al.innerHTML='';r.actions.forEach(function(a){al.innerHTML+=buildActionItem(a)});
  var oc=document.getElementById('osCheck');if(r.oneshot){oc.classList.add('checked');oc.querySelector('span').style.display=''}else{oc.classList.remove('checked');oc.querySelector('span').style.display='none'}
  document.querySelectorAll('.error').forEach(function(el){el.classList.remove('error')});var errEl=document.getElementById('modalError');errEl.classList.remove('show');errEl.textContent='';
  syncPresetHighlight();syncDatePresetHighlight();setTimeout(function(){updateSummary();enforceOneshotOnly()},0);
}
function openModal(mode,rid){
  var isEdit=mode==='edit'&&rid;document.getElementById('modalTitle').textContent=isEdit?'ìŠ¤ì¼€ì¤„ëŸ¬ ìˆ˜ì •':'ìŠ¤ì¼€ì¤„ëŸ¬ ì¶”ê°€';document.getElementById('saveBtn').textContent=isEdit?'ìˆ˜ì •':'ì €ì¥';
  if(isEdit){var r=routineData.find(function(x){return x.id===rid});if(r)populateModal(r)}
  else populateModal({whenType:'schedule',repeatMode:'weekly',days:[],dates:[],timeStart:'',timeEnd:'',_allDay:false,actions:[{service:'',action:'',target:''}],oneshot:false,timing:'ì •ì‹œì—',datetime:''});
  document.getElementById('modal').classList.add('show');document.body.style.overflow='hidden';
}
function closeModal(){document.getElementById('modal').classList.remove('show');document.body.style.overflow='';if(openDropdownEl)closeSvcDropdown(openDropdownEl)}
function switchWhen(t,b){b.parentElement.querySelectorAll('.tab-btn').forEach(function(x){x.classList.remove('active')});b.classList.add('active');document.getElementById('panelSchedule').style.display=t==='schedule'?'':'none';document.getElementById('panelDatetime').style.display=t==='datetime'?'':'none';updateSummary()}
function toggleDay(e){e.classList.toggle('selected');syncPresetHighlight();updateSummary()}
function selTiming(b){b.parentElement.querySelectorAll('.timing-btn').forEach(function(x){x.classList.remove('active')});b.classList.add('active');updateSummary()}
function toggleAllDay(){var on=document.getElementById('allDayCheck').checked;document.getElementById('timeInputsWrap').style.display=on?'none':'';document.getElementById('allDayMsg').style.display=on?'':'none';if(on){document.getElementById('timeStart').value='';document.getElementById('timeEnd').value=''}updateSummary()}
function validateAndSave(){
  document.querySelectorAll('.error').forEach(function(el){el.classList.remove('error')});var errEl=document.getElementById('modalError');errEl.classList.remove('show');errEl.textContent='';
  var isSchedule=document.getElementById('tabSchedule').classList.contains('active');var errors=[];
  if(isSchedule){
    if(curRepeatMode==='weekly'){var days=document.querySelectorAll('#daySelector .day-btn.selected');if(!days.length){errors.push('ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');document.querySelectorAll('#daySelector .day-btn').forEach(function(b){b.style.borderColor='var(--danger)'})}}
    else{var dates=getSelectedDates();if(!dates.length)errors.push('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”')}
    var allDay=document.getElementById('allDayCheck').checked;var locked=checkAllOneshot();
    if(!allDay&&!locked){var ts=document.getElementById('timeStart'),te=document.getElementById('timeEnd');if(!ts.value){errors.push('ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');ts.classList.add('error')}if(ts.value&&te.value&&te.value<=ts.value){errors.push('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤');te.classList.add('error')}}
    else if(locked&&!allDay){var ts=document.getElementById('timeStart');if(!ts.value){errors.push('ì‹¤í–‰ ì‹œê°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');ts.classList.add('error')}}
  }else{var dt=document.getElementById('dtInput');if(!dt.value){errors.push('ë‚ ì§œì™€ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');dt.classList.add('error')}}
  var wraps=document.querySelectorAll('#actionsList .svc-select-wrap');var hasSvc=false;wraps.forEach(function(w){if(w.dataset.selectedKey)hasSvc=true;else{var trigger=w.querySelector('.svc-select-trigger');if(trigger)trigger.classList.add('error')}});if(!hasSvc)errors.push('ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
  if(errors.length){errEl.textContent=errors[0];errEl.classList.add('show');var btn=document.getElementById('saveBtn');btn.classList.add('shake');setTimeout(function(){btn.classList.remove('shake')},300);return}
  closeModal();
}
function addAction(){document.getElementById('actionsList').insertAdjacentHTML('beforeend',buildActionItem({service:'',action:'',target:''}));enforceOneshotOnly()}
function rmAction(b){var i=b.closest('.action-item'),l=i.parentElement;if(l.children.length>1)i.remove();enforceOneshotOnly()}
function toggleOneshot(){var c=document.getElementById('osCheck'),on=c.classList.toggle('checked');c.querySelector('span').style.display=on?'':'none'}
function isOneshotOnlyAction(k){var c=k?svcConfig[k]:null;return c&&c.actions.length===1&&c.actions[0]==='ì‹¤í–‰'}
function checkAllOneshot(){var wraps=document.querySelectorAll('#actionsList .svc-select-wrap');var any=false,all=true;wraps.forEach(function(w){var key=w.dataset.selectedKey;if(key){any=true;if(!isOneshotOnlyAction(key))all=false}});return any&&all}
function enforceOneshotOnly(){
  var locked=checkAllOneshot();var ac=document.getElementById('allDayCheck'),al=document.getElementById('allDayLabel');
  if(locked){if(ac.checked){ac.checked=false;toggleAllDay()}ac.disabled=true;al.style.opacity='.4';al.style.pointerEvents='none';document.getElementById('timeEnd').value='';document.getElementById('ctpEndTrigger').textContent='--:--';tpS.end={h:'',m:''};clTp('ctpEndPanel');document.getElementById('timingMode').querySelectorAll('.timing-btn').forEach(function(b){if(b.dataset.val==='ì •ì‹œì—')b.classList.add('active');else{b.classList.remove('active');b.style.opacity='.4';b.style.pointerEvents='none'}})}
  else{ac.disabled=false;al.style.opacity='';al.style.pointerEvents='';document.getElementById('timingMode').querySelectorAll('.timing-btn').forEach(function(b){b.style.opacity='';b.style.pointerEvents=''})}
  updateSummary();
}

/* ===== íƒ€ì„ë¼ì¸ ===== */
var viewDate=new Date();var dayN=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
var tlRoutines=[
  {id:1,days:[0],start:4,end:4.25,type:'scheduled',actions:['ì¬ì‹œì‘ ì‹¤í–‰']},
  {id:2,fixedDate:'2026-02-26',fixedHour:8,fixedEnd:24,type:'running',actions:['PPTP ì„œë²„ í™œì„±í™”','L2TP ì„œë²„ í™œì„±í™”','WireGuard ì„œë²„ í™œì„±í™”','ê²Œì´ë° VPN í™œì„±í™”']},
  {id:3,days:[1,2,3,4,5],start:8,end:22,type:'scheduled',actions:['ìœˆë„ìš° íŒŒì¼ê³µìœ  í™œì„±í™”']},
  {id:4,fixedDate:'2026-02-27',fixedHour:3,type:'oneshot',actions:['íŒì›¨ì–´ ì—…ê·¸ë ˆì´ë“œ ì‹¤í–‰']},
  {id:5,monthDates:[1,10,20],start:5,end:5.25,type:'scheduled',actions:['ì¬ì‹œì‘ ì‹¤í–‰']},
  {id:6,days:[0,2,4,6],start:18,end:18.25,type:'scheduled',actions:['ì‹œìŠ¤í…œ ë¡œê·¸ ë©”ì¼ ì „ì†¡ ì‹¤í–‰']},
];
function makeTlLabel(actions){var names=actions.map(function(a){return a.replace(/ (í™œì„±í™”|ë¹„í™œì„±í™”|ì‹¤í–‰)$/,'')});if(names.length<=2)return names.join(', ');return names[0]+', '+names[1]+' ì™¸ '+(names.length-2)+'ê±´'}
function fmtD(d){return(d.getMonth()+1)+'/'+String(d.getDate()).padStart(2,'0')+' ('+dayN[d.getDay()]+')'}
function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function shiftDay(n){viewDate.setDate(viewDate.getDate()+n);renderTl()}
function goToday(){viewDate=new Date();renderTl()}
function toggleTl(){var c=document.getElementById('tlContent'),b=document.querySelector('.tl-collapse-btn');if(c.style.display==='none'){c.style.display='';b.textContent='âˆ§'}else{c.style.display='none';b.textContent='âˆ¨'}}
function renderTl(){
  document.getElementById('tlDateDisp').textContent=fmtD(viewDate);var dow=viewDate.getDay(),isToday=sameDay(viewDate,new Date());var ds=viewDate.getFullYear()+'-'+String(viewDate.getMonth()+1).padStart(2,'0')+'-'+String(viewDate.getDate()).padStart(2,'0');
  var ruler=document.getElementById('tlRuler');ruler.innerHTML='';for(var h=0;h<=24;h+=3){var t=document.createElement('span');t.className='tick';t.style.left=(h/24*100)+'%';t.textContent=String(h).padStart(2,'0');ruler.appendChild(t)}
  var grid=document.getElementById('tlGrid');grid.innerHTML='';for(var h=0;h<=24;h+=3){var l=document.createElement('div');l.className='tl-grid-line';l.style.left=(h/24*100)+'%';grid.appendChild(l)}
  var bars=[];tlRoutines.forEach(function(r){var show=false;if(r.fixedDate)show=(r.fixedDate===ds);else if(r.monthDates)show=r.monthDates.includes(viewDate.getDate());else if(r.days)show=r.days.includes(dow);if(!show)return;var s=r.start||r.fixedHour||0,e=r.fixedEnd||r.end||(r.fixedHour?r.fixedHour+.25:24);bars.push(Object.assign({},r,{s:s,e:e,label:makeTlLabel(r.actions)}))});
  var rows=[];bars.forEach(function(b){var placed=false;for(var ri=0;ri<rows.length;ri++){var ok=true;for(var k=0;k<rows[ri].length;k++){var ob=rows[ri][k];if(!(b.s>=ob.e||b.e<=ob.s)){ok=false;break}}if(ok){rows[ri].push(b);b.row=ri;placed=true;break}}if(!placed){b.row=rows.length;rows.push([b])}});
  var overlaps=[];for(var i=0;i<bars.length;i++)for(var j=i+1;j<bars.length;j++){var os=Math.max(bars[i].s,bars[j].s),oe=Math.min(bars[i].e,bars[j].e);if(os<oe)overlaps.push({s:os,e:oe,bars:[bars[i],bars[j]]})}
  var tracks=document.getElementById('tlTracks');tracks.innerHTML='';var rowH=36;tracks.style.height=(rows.length*rowH+8)+'px';tracks.style.position='relative';
  bars.forEach(function(b){var el=document.createElement('div');el.className='tl-bar '+(b.type==='oneshot'?'oneshot':b.type==='running'?'running':'scheduled');el.style.left=(b.s/24*100)+'%';el.style.width=Math.max((b.e-b.s)/24*100,1)+'%';el.style.top=(b.row*rowH+4)+'px';el.textContent=b.label;if(b.actions.length>1){var bg=document.createElement('span');bg.className='badge';bg.textContent='+'+b.actions.length;el.appendChild(bg)}el.addEventListener('mouseenter',function(ev){showTip(ev,b,overlaps)});el.addEventListener('mousemove',moveTip);el.addEventListener('mouseleave',hideTip);el.addEventListener('click',function(){hideTip();openModal('edit',b.id)});tracks.appendChild(el)});
  overlaps.forEach(function(o){var el=document.createElement('div');el.className='tl-overlap';var mn=Math.min(o.bars[0].row,o.bars[1].row),mx=Math.max(o.bars[0].row,o.bars[1].row);el.style.left=(o.s/24*100)+'%';el.style.width=((o.e-o.s)/24*100)+'%';el.style.top=(mn*rowH)+'px';el.style.height=((mx-mn+1)*rowH)+'px';tracks.appendChild(el)});
  if(isToday){var now=new Date(),nh=now.getHours()+now.getMinutes()/60;var nl=document.createElement('div');nl.className='tl-now';nl.style.left=(nh/24*100)+'%';tracks.appendChild(nl)}
}
function showTip(ev,b,ov){var tt=document.getElementById('tooltip');var sh=Math.floor(b.s),sm=Math.round((b.s%1)*60),eh=Math.floor(b.e),em=Math.round((b.e%1)*60);var ts=String(sh).padStart(2,'0')+':'+String(sm).padStart(2,'0')+' ~ '+String(eh).padStart(2,'0')+':'+String(em).padStart(2,'0');if(b.type==='oneshot')ts=String(sh).padStart(2,'0')+':'+String(sm).padStart(2,'0')+' (1íšŒ)';var ol=ov.filter(function(o){return o.bars.includes(b)});var olH='';if(ol.length){var names=[];ol.forEach(function(o){o.bars.forEach(function(x){if(x!==b)names.push(x.label)})});olH='<div class="tt-overlap">ê²¹ì¹¨: '+names.join(', ')+'</div>'}tt.innerHTML='<h4>'+b.label+'</h4><div class="tt-time">'+ts+'</div><ul class="tt-list">'+b.actions.map(function(a){return'<li>'+a+'</li>'}).join('')+'</ul>'+olH;tt.classList.add('show');moveTip(ev)}
function moveTip(ev){var tt=document.getElementById('tooltip');var x=ev.clientX+12,y=ev.clientY-10;var w=tt.offsetWidth,h=tt.offsetHeight;if(x+w>innerWidth-8)x=ev.clientX-w-12;if(y+h>innerHeight-8)y=innerHeight-h-8;if(y<8)y=8;tt.style.left=x+'px';tt.style.top=y+'px'}
function hideTip(){document.getElementById('tooltip').classList.remove('show')}
renderTl();
var w6=document.getElementById('card6').closest('.routine-card-wrap');
var w2=document.getElementById('card2').closest('.routine-card-wrap');
w2.parentNode.insertBefore(w6,w2);
updatePriorityNumbers();

/* ===== ì»¤ìŠ¤í…€ íƒ€ì„ í”¼ì»¤ ===== */
function buildTimeCols(pid,type){var p=document.getElementById(pid);var hc=document.createElement('div');hc.className='ctp-col';var mc=document.createElement('div');mc.className='ctp-col';for(var h=0;h<24;h++){var c=document.createElement('div');c.className='ctp-cell';c.textContent=String(h).padStart(2,'0');c.dataset.v=String(h).padStart(2,'0');c.dataset.t=type;c.dataset.p='h';c.onclick=function(){pickTime(this)};hc.appendChild(c)}for(var m=0;m<60;m+=5){var c=document.createElement('div');c.className='ctp-cell';c.textContent=String(m).padStart(2,'0');c.dataset.v=String(m).padStart(2,'0');c.dataset.t=type;c.dataset.p='m';c.onclick=function(){pickTime(this)};mc.appendChild(c)}p.appendChild(hc);var s=document.createElement('span');s.className='ctp-sep';s.textContent=':';p.appendChild(s);p.appendChild(mc)}
var tpS={start:{h:'',m:''},end:{h:'',m:''}};
function pickTime(c){var t=c.dataset.t,p=c.dataset.p,v=c.dataset.v;c.parentElement.querySelectorAll('.ctp-cell').forEach(function(x){x.classList.remove('selected')});c.classList.add('selected');tpS[t][p]=v;var tid='ctp'+(t==='start'?'Start':'End')+'Trigger';var iid=t==='start'?'timeStart':'timeEnd';if(tpS[t].h!==''&&tpS[t].m!==''){var tv=tpS[t].h+':'+tpS[t].m;document.getElementById(iid).value=tv;document.getElementById(tid).textContent=tv}else if(tpS[t].h!==''){document.getElementById(tid).textContent=tpS[t].h+':--'}else if(tpS[t].m!==''){document.getElementById(tid).textContent='--:'+tpS[t].m}updateSummary()}
function toggleCtp(t){var pid='ctp'+(t==='start'?'Start':'End')+'Panel',tid='ctp'+(t==='start'?'Start':'End')+'Trigger';var p=document.getElementById(pid),tr=document.getElementById(tid);var o=p.classList.contains('show');closeAllPickers();if(!o){p.classList.add('show');tr.classList.add('open');p.querySelectorAll('.ctp-col').forEach(function(col){var sel=col.querySelector('.ctp-cell.selected');if(sel)setTimeout(function(){sel.scrollIntoView({block:'center',behavior:'instant'})},0)})}}
function closeAllPickers(){document.querySelectorAll('.ctp-panel,.cdtp-panel').forEach(function(p){p.classList.remove('show')});document.querySelectorAll('.ctp-trigger,.cdtp-trigger').forEach(function(t){t.classList.remove('open')})}
buildTimeCols('ctpStartPanel','start');buildTimeCols('ctpEndPanel','end');

/* ===== ì»¤ìŠ¤í…€ ë‚ ì§œì‹œê°„ í”¼ì»¤ ===== */
var cpY,cpM,cpD,cpH='',cpMi='';
function buildCal(){var p=document.getElementById('cdtpPanel');var n=new Date();if(!cpY){cpY=n.getFullYear();cpM=n.getMonth()}var h='<div class="cal-header"><button class="cal-nav" onclick="event.stopPropagation();cpNav(-1)">â—€</button><span>'+cpY+'ë…„ '+(cpM+1)+'ì›”</span><button class="cal-nav" onclick="event.stopPropagation();cpNav(1)">â–¶</button></div>';h+='<div class="cal-dow"><span>ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span></div><div class="cal-grid">';var fd=new Date(cpY,cpM,1).getDay(),dim=new Date(cpY,cpM+1,0).getDate(),pd=new Date(cpY,cpM,0).getDate();for(var i=0;i<fd;i++)h+='<button class="cal-day other" disabled>'+(pd-fd+i+1)+'</button>';for(var d=1;d<=dim;d++){var cl='cal-day';if(d===n.getDate()&&cpM===n.getMonth()&&cpY===n.getFullYear())cl+=' today';if(d===cpD)cl+=' selected';h+='<button class="'+cl+'" onclick="event.stopPropagation();pickDay('+d+')">'+d+'</button>'}var rem=(fd+dim)%7;if(rem)for(var i=1;i<=7-rem;i++)h+='<button class="cal-day other" disabled>'+i+'</button>';h+='</div><div class="cal-time"><div class="cal-time-col" id="cdtpHCol">';for(var hh=0;hh<24;hh++){var hs=String(hh).padStart(2,'0');h+='<div class="cal-time-cell'+(cpH===hs?' selected':'')+'" onclick="event.stopPropagation();pickDt(\'h\',\''+hs+'\')">'+hs+'</div>'}h+='</div><span class="cal-time-sep">:</span><div class="cal-time-col" id="cdtpMCol">';for(var mm=0;mm<60;mm+=5){var ms=String(mm).padStart(2,'0');h+='<div class="cal-time-cell'+(cpMi===ms?' selected':'')+'" onclick="event.stopPropagation();pickDt(\'m\',\''+ms+'\')">'+ms+'</div>'}h+='</div></div>';p.innerHTML=h;setTimeout(function(){var hc=document.getElementById('cdtpHCol'),mc=document.getElementById('cdtpMCol');if(hc){var s=hc.querySelector('.selected');if(s)s.scrollIntoView({block:'center',behavior:'instant'})}if(mc){var s=mc.querySelector('.selected');if(s)s.scrollIntoView({block:'center',behavior:'instant'})}},0)}
function cpNav(d){cpM+=d;if(cpM<0){cpM=11;cpY--}if(cpM>11){cpM=0;cpY++}buildCal()}
function pickDay(d){cpD=d;buildCal();syncDt()}
function pickDt(p,v){if(p==='h')cpH=v;else cpMi=v;buildCal();syncDt()}
function syncDt(){var tr=document.getElementById('cdtpTrigger');if(cpD&&cpH!==''&&cpMi!==''){var v=cpY+'-'+String(cpM+1).padStart(2,'0')+'-'+String(cpD).padStart(2,'0')+'T'+cpH+':'+cpMi;document.getElementById('dtInput').value=v;tr.textContent=v.replace('T','  ');updateSummary()}else if(cpD){tr.innerHTML=cpY+'-'+String(cpM+1).padStart(2,'0')+'-'+String(cpD).padStart(2,'0')+'  <span class="placeholder">ì‹œê°„ ì„ íƒ</span>'}else{tr.innerHTML='<span class="placeholder">ë‚ ì§œ ë° ì‹œê°„ ì„ íƒ...</span>'}}
function toggleCdtp(){var p=document.getElementById('cdtpPanel'),t=document.getElementById('cdtpTrigger');var o=p.classList.contains('show');closeAllPickers();if(!o){buildCal();p.classList.add('show');t.classList.add('open')}}

/* í”¼ì»¤ ë™ê¸°í™” */
var _opm=populateModal;populateModal=function(r){_opm(r);syncPickers()};
var _ovs=validateAndSave;validateAndSave=function(){_ovs();if(document.getElementById('timeStart').classList.contains('error'))document.getElementById('ctpStartTrigger').classList.add('error');if(document.getElementById('timeEnd').classList.contains('error'))document.getElementById('ctpEndTrigger').classList.add('error');if(document.getElementById('dtInput').classList.contains('error'))document.getElementById('cdtpTrigger').classList.add('error')};
function syncPickers(){
  var ts=document.getElementById('timeStart').value,te=document.getElementById('timeEnd').value;
  var tst=document.getElementById('ctpStartTrigger'),tet=document.getElementById('ctpEndTrigger');
  tpS.start={h:'',m:''};tpS.end={h:'',m:''};
  clTp('ctpStartPanel');clTp('ctpEndPanel');
  if(ts){var p=ts.split(':');tpS.start.h=p[0];tpS.start.m=p[1];tst.textContent=ts;hlTp('ctpStartPanel',p[0],p[1])}else{tst.textContent='--:--'}
  if(te){var p=te.split(':');tpS.end.h=p[0];tpS.end.m=p[1];tet.textContent=te;hlTp('ctpEndPanel',p[0],p[1])}else if(ts){tpS.end.h=tpS.start.h;tpS.end.m=tpS.start.m;tet.textContent=ts;hlTp('ctpEndPanel',tpS.start.h,tpS.start.m);document.getElementById('timeEnd').value=ts}else{tet.textContent='--:--'}
  var dt=document.getElementById('dtInput').value;
  if(dt){var d=new Date(dt);cpY=d.getFullYear();cpM=d.getMonth();cpD=d.getDate();cpH=String(d.getHours()).padStart(2,'0');cpMi=String(d.getMinutes()).padStart(2,'0');document.getElementById('cdtpTrigger').textContent=dt.replace('T','  ')}else{var n=new Date();cpY=n.getFullYear();cpM=n.getMonth();cpD=null;cpH='';cpMi='';document.getElementById('cdtpTrigger').innerHTML='<span class="placeholder">ë‚ ì§œ ë° ì‹œê°„ ì„ íƒ...</span>'}
  closeAllPickers();
}
function hlTp(pid,h,m){var p=document.getElementById(pid);var cols=p.querySelectorAll('.ctp-col');if(cols.length>=2){cols[0].querySelectorAll('.ctp-cell').forEach(function(c){c.classList.toggle('selected',c.dataset.v===h)});var mi=Math.round(parseInt(m)/5)*5;var ms=String(mi>=60?55:mi).padStart(2,'0');cols[1].querySelectorAll('.ctp-cell').forEach(function(c){c.classList.toggle('selected',c.dataset.v===ms)})}}
function clTp(pid){document.getElementById(pid).querySelectorAll('.ctp-cell').forEach(function(c){c.classList.remove('selected')})}
document.addEventListener('click',function(e){if(!e.target.closest('.ctp-wrap')&&!e.target.closest('.cdtp-wrap'))closeAllPickers()});
</script>
</body>
</html>
